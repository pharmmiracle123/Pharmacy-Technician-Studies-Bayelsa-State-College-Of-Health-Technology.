<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTS Payment Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for PDF receipts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <style>
    .receipt-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">

  <div class="flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-blue-900 text-white min-h-screen p-6 hidden md:block">
      <div class="flex items-center gap-3 mb-6">
        <img id="logoSmall" src="logo.png" alt="logo" class="w-12 h-12 object-contain bg-white rounded p-1"/>
        <h2 class="text-2xl font-bold">PTS Payments</h2>
      </div>

      <nav class="mt-4">
        <ul class="space-y-3">
          <li><button onclick="showSection('dashboard')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üè† Dashboard</button></li>
          <li><button onclick="showSection('payment')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üí≥ Make Payment</button></li>
          <li><button onclick="showSection('history')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üìú Payment History</button></li>
          <li><button onclick="showSection('profile')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üë§ Student Profile</button></li>
          <li><button onclick="showSection('settings')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">‚öô Settings</button></li>
        </ul>
      </nav>

      <div class="mt-8 space-y-3">
        <button onclick="toggleDarkMode()" class="w-full bg-gray-700 text-white py-2 rounded">üåô Toggle Dark Mode</button>
        <button onclick="logoutProfile()" class="w-full bg-red-600 text-white py-2 rounded">üö™ Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">

      <!-- Header -->
      <header class="flex items-center justify-between bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-6">
        <div class="flex items-center gap-4">
          <img id="logoHeader" src="logo.png" alt="PTS Logo" class="h-12 w-12 object-contain bg-white rounded p-1"/>
          <div>
            <h1 class="text-xl font-bold text-blue-900 dark:text-white">PTS Fees Dashboard</h1>
            <p class="text-sm text-gray-500">Payments ‚Ä¢ Receipts ‚Ä¢ Reports</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="menuToggle" onclick="toggleSidebar()" class="md:hidden px-3 py-2 bg-blue-700 text-white rounded">‚ò∞ Menu</button>
          <div class="text-right">
            <div id="userNameDisplay" class="text-sm text-gray-600 dark:text-gray-200">Not signed in</div>
            <div class="text-xs text-gray-400">PTS Payment System</div>
          </div>
        </div>
      </header>

      <!-- Notification -->
      <section id="notificationSection" class="hidden bg-yellow-100 text-yellow-900 p-3 rounded mb-6">
        <p id="notificationMsg">Notification</p>
      </section>

      <!-- Dashboard -->
      <section id="dashboardSection" class="space-y-6">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Total Payments</h3>
            <p id="totalPayments" class="text-2xl font-bold text-blue-700">‚Ç¶0</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Department Fees</h3>
            <p id="totalDept" class="text-2xl font-bold text-green-700">‚Ç¶0</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Association Dues</h3>
            <p id="totalSchool" class="text-2xl font-bold text-purple-700">‚Ç¶0</p>
          </div>
        </div>

        <!-- Announcements -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h3 class="font-bold text-blue-900 dark:text-white mb-3">üì¢ Announcements</h3>
          <ul class="list-disc pl-6 text-sm space-y-2">
            <li>Deadline for Year 3 Project Fee Payment: <b>October 30, 2025</b></li>
            <li>New bank details updated for direct transfers</li>
            <li>Orientation for Year 1 students will hold on <b>November 5, 2025</b></li>
          </ul>
        </div>

        <!-- Chart -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h3 class="font-bold text-blue-900 dark:text-white mb-3">üìä Payment <Overview></Overview></h3>
          <canvas id="paymentChart" height="200"></canvas>
        </div>
      </section>

      <!-- Payment -->
      <section id="paymentSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 dark:text-white mb-4">üí≥ Make a Payment</h2>

        <form id="paymentForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="studentName" type="text" placeholder="Full Name" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
            <input id="studentMatric" type="text" placeholder="Matric Number" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <select id="studentYear" onchange="updateFees()" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
              <option value="">-- Select Year --</option>
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
            </select>
            <select id="paymentType" onchange="updateFees()" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
              <option value="All">All Fees (recommended)</option>
              <option value="Course enrollment">Course enrollment</option>
              <option value="I.T fee">I.T fee</option>
              <option value="Departmental dues">Departmental dues</option>
              <option value="Practical fee">Practical fee</option>
              <option value="Project fee">Project fee</option>
            </select>
          </div>

          <div id="feeBreakdown" class="bg-gray-50 dark:bg-gray-800 p-3 rounded text-sm receipt-mono"></div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
            <input id="totalAmount" type="number" placeholder="Amount" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" readonly>
            <button type="button" onclick="makePayment()" class="bg-blue-700 text-white py-2 rounded">Pay Now</button>
          </div>
        </form>
      </section>

      <!-- History -->
      <section id="historySection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">üìú Payment History</h2>

        <div class="flex flex-wrap gap-3 mb-4">
          <input id="searchHistory" oninput="filterHistory()" placeholder="üîç Search by Name, Matric, or Year" class="flex-1 border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <button onclick="downloadHistoryPDF()" class="bg-blue-700 text-white px-4 py-2 rounded">‚¨á Export PDF</button>
          <button onclick="downloadHistoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded">‚¨á Export Excel</button>
          <button onclick="clearHistory()" class="bg-red-600 text-white px-4 py-2 rounded">üóëÔ∏è Clear</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full table-auto text-sm">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Matric</th>
                <th class="p-2 text-left">Year</th>
                <th class="p-2 text-left">Fee Type</th>
                <th class="p-2 text-left">Amount</th>
                <th class="p-2 text-left">Date</th>
                <th class="p-2 text-left">Ref</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="bg-white dark:bg-gray-800"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profileSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">üë§ Student Profile</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="profileName" placeholder="Full Name" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <input id="profileMatric" placeholder="Matric Number" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <input id="profileEmail" placeholder="Email Address" type="email" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
        </div>
        <div class="mt-4 flex gap-3">
          <button onclick="saveProfile()" class="bg-purple-700 text-white px-4 py-2 rounded">Save Profile</button>
          <button onclick="logoutProfile()" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
        </div>
      </section>

      <!-- Settings -->
      <section id="settingsSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">‚öô Settings</h2>
        <p class="text-sm text-gray-500">Here you can configure your notifications, backups, and integrations.</p>
      </section>

    </main>
  </div>
<script type="module">
/* ======= Firebase + Paystack Integrated App Script ======= */

// üîπ Import Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  updateDoc, 
  collection, 
  addDoc, 
  getDocs, 
  deleteDoc 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ‚úÖ Your Firebase Config (replace with real one you gave me earlier)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// üîπ Paystack setup
const PAYSTACK_PUBLIC_KEY = "pk_live_258fa9605c51c7f7a1f5c20e0254ddf80671d878"; 
const SUBACCOUNT_YEAR2 = "ACCT_06hfn80x3hk1neo";
const SUBACCOUNT_YEAR3 = "ACCT_x5ze130sh1rjex6";

const fees = {
  1: { "Course enrollment": 1000, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  2: { "Course enrollment": 1000, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  3: { "Course enrollment": 1000, "Departmental dues": 6000, "Practical fee": 4000, "Project fee": 15000 }
};

let currentUser = null;
let history = [];
let darkMode = false;

/* ------------------- UI / Navigation ------------------- */
function toggleDarkMode() {
  darkMode = !darkMode;
  document.body.classList.toggle("dark", darkMode);
  if (currentUser) {
    const userRef = doc(db, "profiles", currentUser.uid);
    updateDoc(userRef, { darkMode });
  }
}
window.toggleDarkMode = toggleDarkMode;

function toggleSidebar() {
  const s = document.getElementById("sidebar");
  if (s) s.classList.toggle("hidden");
}
window.toggleSidebar = toggleSidebar;

function showNotification(msg) {
  const el = document.getElementById("notificationSection");
  if (!el) return;
  document.getElementById("notificationMsg").innerText = msg;
  el.classList.remove("hidden");
  setTimeout(() => el.classList.add("hidden"), 3500);
}

function showSection(s) {
  const sections = ["dashboard","payment","history","profile","settings"];
  sections.forEach(id => {
    const el = document.getElementById(id + "Section");
    if (el) el.classList.add("hidden");
  });
  const target = document.getElementById(s + "Section");
  if (target) target.classList.remove("hidden");
  updateSummary();
  renderChart();
  renderHistory();
}
window.showSection = showSection;

/* ------------------- Payment / Fees ------------------- */
function updateFees(){
  const year = document.getElementById("studentYear")?.value;
  const type = document.getElementById("paymentType")?.value || "All";
  const breakdown = document.getElementById("feeBreakdown");
  if (!breakdown) return;
  breakdown.innerHTML = "";
  if (!year) { document.getElementById("totalAmount").value = ""; return; }
  const items = fees[year] || {};
  let html = "";
  let total = 0;
  Object.entries(items).forEach(([k, v]) => {
    if (type === "All" || type === k) {
      html += `<div class="flex justify-between"><span>${k}</span><span>‚Ç¶${v.toLocaleString()}</span></div>`;
      total += v;
    }
  });
  breakdown.innerHTML = html + `<hr class="my-2"><div class="flex justify-between font-bold"><div>Total</div><div>‚Ç¶${total.toLocaleString()}</div></div>`;
  document.getElementById("totalAmount").value = total;
}
window.updateFees = updateFees;

async function makePayment(){
  if (!currentUser) return alert("‚ö† Please login first.");
  const name = (document.getElementById("studentName")?.value || "").trim();
  const matric = (document.getElementById("studentMatric")?.value || "").trim();
  const year = document.getElementById("studentYear")?.value;
  const amount = Number(document.getElementById("totalAmount")?.value || 0);
  const type = document.getElementById("paymentType")?.value || "All";

  if (!name || !matric || !year || amount <= 0) {
    return alert("‚ö† Please fill all fields and ensure amount > 0");
  }

  let subaccountCode = null;
  if (year == "2") subaccountCode = SUBACCOUNT_YEAR2;
  if (year == "3") subaccountCode = SUBACCOUNT_YEAR3;

  const handler = PaystackPop.setup({
    key: PAYSTACK_PUBLIC_KEY,
    email: currentUser.email || `${matric}@pts.edu.ng`,
    amount: Math.round(amount * 100),
    currency: "NGN",
    ref: "PTS_" + Math.floor(Math.random() * 1e9),
    subaccount: subaccountCode,
    metadata: {
      custom_fields: [
        { display_name: "Student Name", variable_name: "student_name", value: name },
        { display_name: "Matric No", variable_name: "matric", value: matric }
      ]
    },
    callback: async (res) => {
      const record = { 
        name, matric, year, feeType: type, amount, 
        date: new Date().toLocaleString(), reference: res.reference 
      };
      // save to Firestore
      await addDoc(collection(db, "payments", currentUser.uid, "history"), record);
      history.push(record);
      showNotification("‚úÖ Payment successful! Ref: " + res.reference);
      renderHistory();
      updateSummary();
      renderChart();
    },
    onClose: () => {
      showNotification("‚ùå Payment window closed.");
    }
  });
  handler.openIframe();
}
window.makePayment = makePayment;

/* ------------------- History ------------------- */
async function loadHistory() {
  if (!currentUser) return;
  history = [];
  const snap = await getDocs(collection(db, "payments", currentUser.uid, "history"));
  snap.forEach(docSnap => history.push(docSnap.data()));
  renderHistory();
  updateSummary();
  renderChart();
}

function renderHistory(){
  const tbody = document.getElementById("historyTable");
  if (!tbody) return;
  tbody.innerHTML = history.map(h => `
    <tr class="border-b">
      <td class="p-2">${escapeHtml(h.name)}</td>
      <td class="p-2">${escapeHtml(h.matric)}</td>
      <td class="p-2">${escapeHtml(h.year)}</td>
      <td class="p-2">${escapeHtml(h.feeType)}</td>
      <td class="p-2">‚Ç¶${Number(h.amount).toLocaleString()}</td>
      <td class="p-2">${escapeHtml(h.date)}</td>
      <td class="p-2">${escapeHtml(h.reference || "-")}</td>
    </tr>`).join("");
}
window.renderHistory = renderHistory;

/* ------------------- Profile ------------------- */
async function loadProfile(){
  if (!currentUser) return;
  const profileDoc = await getDoc(doc(db, "profiles", currentUser.uid));
  const data = profileDoc.exists() ? profileDoc.data() : {};
  if (document.getElementById("profileName")) document.getElementById("profileName").value = data.name || currentUser.displayName || "";
  if (document.getElementById("profileMatric")) document.getElementById("profileMatric").value = data.matric || "";
  if (document.getElementById("profileEmail")) document.getElementById("profileEmail").value = currentUser.email || "";
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = data.name || currentUser.displayName || "Not signed in";
  if (document.getElementById("profilePic")) document.getElementById("profilePic").src = currentUser.photoURL || "default-avatar.png";
  if (data.darkMode) { darkMode = true; document.body.classList.add("dark"); }
}
window.loadProfile = loadProfile;

async function saveProfile(){
  if (!currentUser) return;
  const p = {
    name: (document.getElementById("profileName")?.value || "").trim(),
    matric: (document.getElementById("profileMatric")?.value || "").trim(),
    email: (document.getElementById("profileEmail")?.value || "").trim(),
    darkMode
  };
  await setDoc(doc(db, "profiles", currentUser.uid), p, { merge: true });
  showNotification("‚úÖ Profile saved to cloud.");
}
window.saveProfile = saveProfile;

function logoutProfile(){
  signOut(auth).then(() => {
    showNotification("Logged out.");
    currentUser = null;
    history = [];
    renderHistory();
  });
}
window.logoutProfile = logoutProfile;

/* ------------------- Summary & Charts ------------------- */
function updateSummary() {
  let total = 0, dept = 0, school = 0;
  history.forEach(h => {
    const amt = Number(h.amount) || 0;
    total += amt;
    const ft = (h.feeType || "").toLowerCase();
    if (ft.includes("department")) dept += amt;
    if (ft.includes("association") || ft.includes("school")) school += amt;
  });
  const totalEl = document.getElementById("totalPayments");
  const deptEl = document.getElementById("totalDept");
  const schoolEl = document.getElementById("totalSchool");
  if (totalEl) totalEl.innerText = "‚Ç¶" + total.toLocaleString();
  if (deptEl) deptEl.innerText = "‚Ç¶" + dept.toLocaleString();
  if (schoolEl) schoolEl.innerText = "‚Ç¶" + school.toLocaleString();
}

let myChart = null;
function renderChart(){
  const canvas = document.getElementById("paymentChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const deptTotal = history.filter(h => (h.feeType || "").toLowerCase().includes("department")).reduce((s, r) => s + Number(r.amount), 0);
  const schoolTotal = history.filter(h => (h.feeType || "").toLowerCase().includes("association") || (h.feeType || "").toLowerCase().includes("school")).reduce((s, r) => s + Number(r.amount), 0);
  const other = history.reduce((s, r) => s + Number(r.amount), 0) - deptTotal - schoolTotal;

  if (myChart) myChart.destroy();
  myChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Departmental", "Association/School", "Other"],
      datasets: [{ data: [deptTotal, schoolTotal, other], backgroundColor: ["#34d399","#8b5cf6","#f59e0b"] }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
  });
}

/* ------------------- Utilities ------------------- */
function escapeHtml(s){ if (!s) return ""; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* ------------------- Init ------------------- */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    await loadProfile();
    await loadHistory();
    showSection("dashboard");
  } else {
    currentUser = null;
    showNotification("‚ö† Not signed in.");
  }
});

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("studentYear")?.addEventListener("change", updateFees);
  document.getElementById("paymentType")?.addEventListener("change", updateFees);
});
</script>> 
</body>
</html>
