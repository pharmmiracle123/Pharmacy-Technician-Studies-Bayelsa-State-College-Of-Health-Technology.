<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTS Payment Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for PDF receipts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <style>
    .receipt-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">

  <div class="flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-blue-900 text-white min-h-screen p-6 hidden md:block">
      <div class="flex items-center gap-3 mb-6">
        <!-- ADD LOGO URL HERE: set the src to your logo link -->
        <img id="logoSmall" src="" alt="logo" class="w-12 h-12 object-contain bg-white rounded p-1"/>
        <h2 class="text-2xl font-bold">PTS Payments</h2>
      </div>

      <nav class="mt-4">
        <ul class="space-y-3">
          <li><button id="navDashboard" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">🏠 Dashboard</button></li>
          <li><button id="navPayment" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">💳 Make Payment</button></li>
          <li><button id="navHistory" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">📜 Payment History</button></li>
          <li><button id="navProfile" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">👤 Student Profile</button></li>
          <li><button id="navSettings" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">⚙ Settings</button></li>
          <!-- Admin dashboard button (hidden unless admin) -->
          <li id="navAdminLi" class="hidden"><button id="navAdmin" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">📊 Admin</button></li>
        </ul>
      </nav>

      <div class="mt-8 space-y-3">
        <button id="darkToggle" class="w-full bg-gray-700 text-white py-2 rounded">🌙 Toggle Dark Mode</button>
        <button id="logoutBtn" class="w-full bg-red-600 text-white py-2 rounded">🚪 Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">

      <!-- Header -->
      <header class="flex items-center justify-between bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-6">
        <div class="flex items-center gap-4">
          <!-- ADD LOGO URL HERE: set the src to your logo link -->
          <img id="logoHeader" src="" alt="PTS Logo" class="h-12 w-12 object-contain bg-white rounded p-1"/>
          <div>
            <h1 class="text-xl font-bold text-blue-900 dark:text-white">PTS Fees Dashboard</h1>
            <p class="text-sm text-gray-500">Payments • Receipts • Reports</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="menuToggle" class="md:hidden px-3 py-2 bg-blue-700 text-white rounded">☰ Menu</button>
          <div class="text-right">
            <div id="userNameDisplay" class="text-sm text-gray-600 dark:text-gray-200">Not signed in</div>
            <div id="userRoleDisplay" class="text-xs text-gray-400">PTS Payment System</div>
          </div>
        </div>
      </header>

      <!-- Notification -->
      <section id="notificationSection" class="hidden bg-yellow-100 text-yellow-900 p-3 rounded mb-6">
        <p id="notificationMsg">Notification</p>
      </section>

      <!-- Dashboard -->
      <section id="dashboardSection" class="space-y-6">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Total Payments</h3>
            <p id="totalPayments" class="text-2xl font-bold text-blue-700">₦0</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Department Fees</h3>
            <p id="totalDept" class="text-2xl font-bold text-green-700">₦0</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Association Dues</h3>
            <p id="totalSchool" class="text-2xl font-bold text-purple-700">₦0</p>
          </div>
        </div>

        <!-- Announcements -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h3 class="font-bold text-blue-900 dark:text-white mb-3">📢 Announcements</h3>
          <ul class="list-disc pl-6 text-sm space-y-2">
            <li>Deadline for Year 3 Project Fee Payment: <b>October 30, 2025</b></li>
            <li>New bank details updated for direct transfers</li>
            <li>Orientation for Year 1 students will hold on <b>November 5, 2025</b></li>
          </ul>
        </div>

        <!-- Chart -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h3 class="font-bold text-blue-900 dark:text-white mb-3">📊 Payment Overview</h3>
          <canvas id="paymentChart" height="200"></canvas>
        </div>
      </section>

      <!-- Payment -->
      <section id="paymentSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 dark:text-white mb-4">💳 Make a Payment</h2>

        <form id="paymentForm" class="space-y-4" onsubmit="event.preventDefault(); makePayment();">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="studentName" name="studentName" type="text" placeholder="Full Name" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
            <input id="studentMatric" name="studentMatric" type="text" placeholder="Matric Number" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <select id="studentYear" onchange="updateFees()" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
              <option value="">-- Select Year --</option>
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
            </select>
            <select id="paymentType" onchange="updateFees()" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
              <option value="All">All Fees (recommended)</option>
              <option value="Course enrollment">Course enrollment</option>
              <option value="I.T fee">I.T fee</option>
              <option value="Departmental dues">Departmental dues</option>
              <option value="Practical fee">Practical fee</option>
              <option value="Project fee">Project fee</option>
            </select>
          </div>

          <div id="feeBreakdown" class="bg-gray-50 dark:bg-gray-800 p-3 rounded text-sm receipt-mono"></div>

          <!-- NOTE: split preview removed to avoid exposing percentage breakdown -->

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
            <input id="totalAmount" name="totalAmount" type="number" placeholder="Amount" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" readonly>
            <div class="flex gap-2">
              <button type="submit" class="bg-blue-700 text-white py-2 px-4 rounded">Pay Now</button>
            </div>
          </div>
        </form>
      </section>

      <!-- History -->
      <section id="historySection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">📜 Payment History</h2>

        <div class="flex flex-wrap gap-3 mb-4">
          <input id="searchHistory" oninput="filterHistory()" placeholder="🔍 Search by Name, Matric, or Year" class="flex-1 border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <button onclick="downloadHistoryPDF()" class="bg-blue-700 text-white px-4 py-2 rounded">⬇ Export PDF</button>
          <button onclick="downloadHistoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded">⬇ Export Excel</button>
          <button onclick="clearHistory()" class="bg-red-600 text-white px-4 py-2 rounded">🗑️ Clear</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full table-auto text-sm">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Matric</th>
                <th class="p-2 text-left">Year</th>
                <th class="p-2 text-left">Fee Type</th>
                <th class="p-2 text-left">Amount</th>
                <th class="p-2 text-left">Date</th>
                <th class="p-2 text-left">Ref</th>
                <th class="p-2 text-left">Receipt</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="bg-white dark:bg-gray-800"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profileSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">👤 Student Profile</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="profileName" placeholder="Full Name" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <input id="profileMatric" placeholder="Matric Number" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <input id="profileEmail" placeholder="Email Address" type="email" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
        </div>
        <div class="mt-4 flex gap-3">
          <button id="saveProfileBtn" class="bg-purple-700 text-white px-4 py-2 rounded">Save Profile</button>
          <button id="logoutProfileBtn" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
        </div>
      </section>

      <!-- Admin (hidden by default) -->
      <section id="adminSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">🔒 Admin Dashboard</h2>
        <div class="mb-4 flex gap-3">
          <button id="refreshAllPayments" class="bg-blue-700 text-white px-4 py-2 rounded">Refresh</button>
          <button id="exportAllPayments" class="bg-green-600 text-white px-4 py-2 rounded">Export CSV</button>
        </div>

        <div class="overflow-x-auto">
          <table id="adminTable" class="w-full table-auto text-sm">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-2 text-left">Date</th>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Matric</th>
                <th class="p-2 text-left">Year</th>
                <th class="p-2 text-left">Fee Type</th>
                <th class="p-2 text-left">Amount</th>
                <th class="p-2 text-left">Ref</th>
                <th class="p-2 text-left">Receipt</th>
              </tr>
            </thead>
            <tbody id="adminTableBody" class="bg-white dark:bg-gray-800"></tbody>
          </table>
        </div>
      </section>

      <!-- Settings -->
      <section id="settingsSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">⚙ Settings</h2>
        <p class="text-sm text-gray-500">Here you can configure your notifications, backups, and integrations.</p>
      </section>

    </main>
  </div>

<!-- ========================= SCRIPT (module) ========================= -->
<script type="module">
/*
  Full client-side behavior using Firebase modular SDK v11 and Paystack inline.
  - Uses your Firebase config and Paystack keys you've provided earlier.
  - Leave the Cloud Function URL placeholders and webhook info to be implemented server-side.
*/

/* --------------------- CONFIG & KEYS (as requested) --------------------- */
const PAYSTACK_PUBLIC_KEY = "pk_live_258fa9605c51c7f7a1f5c20e0254ddf80671d878";
const PAYSTACK_SPLIT_CODE = "SPL_Ijp4pkn553";

// Firebase modular imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

/* --------------------- FIREBASE CONFIG (user supplied) --------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBzuQuY_9BSGrhQmN2zuH7bgS8nUOBZRnA",
  authDomain: "pts-bscht.firebaseapp.com",
  projectId: "pts-bscht",
  storageBucket: "pts-bscht.firebasestorage.app",
  messagingSenderId: "860500545291",
  appId: "1:860500545291:web:60df69992bcaddcb0bdc0e",
  measurementId: "G-B9NTEZYFMM"
};

/* --------------------- INIT FIREBASE --------------------- */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const functions = getFunctions(app);

/* --------------------- ADMIN CONFIG ---------------------
   Add the admin emails (or uids) that should be allowed to see the admin dashboard.
*/
const ADMIN_EMAILS = ["admin@pts.edu.ng"]; // <-- replace with actual admin email(s)

/* --------------------- Fee structure --------------------- */
const fees = {
  1: { "Course enrollment": 200, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  2: { "Course enrollment": 1000, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  3: { "Course enrollment": 1000, "Departmental dues": 6000, "Practical fee": 4000, "Project fee": 15000 }
};

/* ------------------- Local state ------------------- */
let history = JSON.parse(localStorage.getItem("paymentHistory") || "[]");
let currentUser = null;

/* ------------------- MENU & NAV FIXES ------------------- */
function ensureNavButtons() {
  // wire up nav buttons (we added ids)
  document.getElementById("navDashboard").addEventListener("click", () => showSection("dashboard"));
  document.getElementById("navPayment").addEventListener("click", () => showSection("payment"));
  document.getElementById("navHistory").addEventListener("click", () => showSection("history"));
  document.getElementById("navProfile").addEventListener("click", () => showSection("profile"));
  document.getElementById("navSettings").addEventListener("click", () => showSection("settings"));
  document.getElementById("navAdmin")?.addEventListener("click", () => showSection("admin"));

  // mobile menu toggle
  document.getElementById("menuToggle").addEventListener("click", toggleSidebar);
  document.getElementById("darkToggle").addEventListener("click", toggleDarkMode);
  document.getElementById("logoutBtn").addEventListener("click", logoutProfile);
  document.getElementById("saveProfileBtn").addEventListener("click", saveProfile);
  document.getElementById("logoutProfileBtn").addEventListener("click", logoutProfile);

  // admin controls
  document.getElementById("refreshAllPayments").addEventListener("click", loadAllPaymentsForAdmin);
  document.getElementById("exportAllPayments").addEventListener("click", exportAdminCSV);
}

/* ensure logo placeholders are left empty so user can paste their logo link */
document.getElementById("logoHeader").src = ""; // <-- paste your logo URL here
document.getElementById("logoSmall").src = "";  // <-- paste your logo URL here

/* ------------------- UI Helpers ------------------- */
function toggleDarkMode() {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}

function toggleSidebar() {
  const s = document.getElementById("sidebar");
  if (!s) return;
  s.classList.toggle("hidden");
}

function showNotification(msg) {
  const el = document.getElementById("notificationSection");
  if (!el) return;
  document.getElementById("notificationMsg").innerText = msg;
  el.classList.remove("hidden");
  setTimeout(() => el.classList.add("hidden"), 4000);
}

/* showSection implementation - keeps HTML untouched */
function showSection(s) {
  const sections = ["dashboard","payment","history","profile","settings","admin"];
  sections.forEach(id => {
    const el = document.getElementById(id + "Section");
    if (el) el.classList.add("hidden");
  });
  const target = document.getElementById(s + "Section");
  if (target) target.classList.remove("hidden");
  updateSummary();
  renderChart();
  renderHistory();
}

/* ------------------- Fees UI ------------------- */
function updateFees(){
  const year = document.getElementById("studentYear")?.value;
  const type = document.getElementById("paymentType")?.value || "All";
  const breakdown = document.getElementById("feeBreakdown");
  if (!breakdown) return;
  breakdown.innerHTML = "";
  if (!year) { if(document.getElementById("totalAmount")) document.getElementById("totalAmount").value = ""; return; }
  const items = fees[year] || {};
  let html = "";
  let total = 0;
  Object.entries(items).forEach(([k, v]) => {
    if (type === "All" || type === k) {
      html += `<div class="flex justify-between"><span>${k}</span><span>₦${v.toLocaleString()}</span></div>`;
      total += (type === "All" ? v : (type === k ? v : 0));
    }
  });
  if (type !== "All" && !items[type]) total = 0;
  breakdown.innerHTML = html + `<hr class="my-2"><div class="flex justify-between font-bold"><div>Total</div><div>₦${total.toLocaleString()}</div></div>`;
  const totalEl = document.getElementById("totalAmount");
  if (totalEl) totalEl.value = total;
}

/* ------------------- PAYSTACK PAYMENT FLOW ------------------- */
async function makePayment(){
  const name = (document.getElementById("studentName")?.value || "").trim();
  const matric = (document.getElementById("studentMatric")?.value || "").trim();
  const year = document.getElementById("studentYear")?.value;
  const amount = Number(document.getElementById("totalAmount")?.value || 0);
  const type = document.getElementById("paymentType")?.value || "All";
  const email = (document.getElementById("profileEmail")?.value || `${matric}@pts.edu.ng`);

  if (!name || !matric || !year || amount <= 0) {
    return alert("⚠ Please fill all fields and ensure amount > 0");
  }

  // unique reference
  const reference = "PTS_" + Math.floor(Math.random() * 1e9);

  const handler = PaystackPop.setup({
    key: PAYSTACK_PUBLIC_KEY,
    email,
    amount: Math.round(amount * 100), // kobo
    currency: "NGN",
    ref: reference,
    split_code: PAYSTACK_SPLIT_CODE,
    metadata: {
      custom_fields: [
        { display_name: "Student Name", variable_name: "student_name", value: name },
        { display_name: "Matric No", variable_name: "matric", value: matric }
      ]
    },
    callback: async (res) => {
      // Payment succeeded on Paystack side - now save to Firestore and handle receipt
      const record = {
        name,
        matric,
        year,
        feeType: type,
        amount,
        date: new Date().toISOString(),
        reference: res.reference,
        status: "SUCCESS",
        payerEmail: email,
        createdAt: serverTimestamp()
      };

      try {
        // push to local history for instant UI
        history.push(record);
        localStorage.setItem("paymentHistory", JSON.stringify(history));
        renderHistory();
        updateSummary();
        renderChart();

        // save to Firestore
        let docRef;
        if (currentUser && currentUser.uid) {
          docRef = await addDoc(collection(db, "users", currentUser.uid, "payments"), record);
        } else {
          docRef = await addDoc(collection(db, "guest_payments"), record);
        }

        // generate receipt PDF blob
        const { blob, filename } = await generateReceiptPDF(record, true);

        // upload to storage
        const path = `receipts/${docRef.id}/${filename}`;
        const sRef = storageRef(storage, path);
        await uploadBytes(sRef, blob);
        const receiptUrl = await getDownloadURL(sRef);

        // update Firestore doc with receiptUrl
        await setDoc(doc(db, docRef.parent.path, docRef.id), { receiptUrl }, { merge: true });

        // call callable cloud function to send email (must implement server-side)
        try {
          const sendReceipt = httpsCallable(functions, 'sendReceiptEmail'); // implement this function
          await sendReceipt({ email: record.payerEmail, name: record.name, reference: record.reference, receiptUrl });
        } catch (fnErr) {
          // function may not be deployed yet
          console.warn("sendReceiptEmail function call failed (deploy function to send email):", fnErr);
        }

        showNotification("✅ Payment successful! Ref: " + res.reference);
      } catch (err) {
        console.error("Error saving payment or uploading receipt:", err);
        showNotification("⚠ Payment succeeded but saving/uploading failed. Check console.");
      }
    },
    onClose: () => {
      showNotification("❌ Payment window closed.");
    }
  });

  handler.openIframe();
}

/* ------------------- Receipt generation (jsPDF) ------------------- */
/**
 * generateReceiptPDF(record, returnBlob)
 * - returns { blob, filename } when returnBlob = true
 * - uses logoHeader src if provided
 */
async function generateReceiptPDF(record, returnBlob = false) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let y = 40;

    // attempt to convert header logo to dataURL for embedding
    const logoImg = document.getElementById("logoHeader");
    let logoDataUrl = null;
    if (logoImg && logoImg.src) {
      try {
        logoDataUrl = await imgToDataURL(logoImg.src);
      } catch (e) {
        console.warn("Could not load logo for receipt:", e);
      }
    }

    if (logoDataUrl) doc.addImage(logoDataUrl, "PNG", margin, y, 100, 40);
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.text("PTS Payment Receipt", pageWidth - margin, y + 18, { align: "right" });
    y += 60;

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Date: ${new Date(record.date).toLocaleString()}`, margin, y);
    doc.text(`Reference: ${record.reference}`, pageWidth - margin, y, { align: "right" });
    y += 22;

    // box with details
    doc.setDrawColor(200);
    doc.rect(margin, y, pageWidth - margin*2, 120, "S");
    let boxY = y + 20;
    const labelX = margin + 12;
    const valX = pageWidth / 2;
    doc.setFontSize(11);

    doc.text("Student Name:", labelX, boxY);
    doc.text(record.name || "-", valX, boxY);
    boxY += 18;

    doc.text("Matric No:", labelX, boxY);
    doc.text(record.matric || "-", valX, boxY);
    boxY += 18;

    doc.text("Year:", labelX, boxY);
    doc.text(String(record.year || "-"), valX, boxY);
    boxY += 18;

    doc.text("Fee Type:", labelX, boxY);
    doc.text(String(record.feeType || "-"), valX, boxY);
    boxY += 18;

    doc.text("Amount Paid:", labelX, boxY);
    doc.text(`₦${Number(record.amount).toLocaleString()}`, valX, boxY);
    boxY += 20;

    y += 150;

    doc.setFontSize(10);
    doc.text("Notes:", margin, y);
    y += 14;
    doc.setFontSize(9);
    const noteLines = doc.splitTextToSize("This is an autogenerated receipt. For official verification, check the transaction on Paystack using the reference or contact the bursary. The receipt design is editable via the site's logo and the generateReceiptPDF function.", pageWidth - margin*2);
    doc.text(noteLines, margin, y);
    y += noteLines.length * 12 + 20;

    doc.setFontSize(11);
    doc.text("__________________", margin, y);
    doc.text("Authorized Signature", margin, y + 14);

    doc.setFontSize(8);
    doc.text(`Receipt generated by PTS Payments • Ref: ${record.reference}`, margin, doc.internal.pageSize.getHeight() - 30);

    const filename = `Receipt_${(record.matric || "unknown")}_${record.reference}.pdf`;

    if (returnBlob) {
      const pdfBlob = doc.output("blob");
      return { blob: pdfBlob, filename };
    } else {
      doc.save(filename);
    }
  } catch (err) {
    console.error("Receipt generation failed:", err);
    alert("❌ Could not generate receipt PDF.");
    throw err;
  }
}

/* helper to convert image URL to dataURL */
function imgToDataURL(url) {
  return new Promise((resolve, reject) => {
    if (!url) return resolve(null);
    if (url.startsWith("data:")) return resolve(url);
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const dataURL = canvas.toDataURL("image/png");
        resolve(dataURL);
      } catch (e) {
        reject(e);
      }
    };
    img.onerror = (e) => reject(e);
    img.src = url;
  });
}

/* ------------------- Upload helper (Storage) ------------------- */
async function uploadBlobToStorage(blob, path) {
  const sRef = storageRef(storage, path);
  const result = await uploadBytes(sRef, blob);
  return await getDownloadURL(result.ref);
}

/* ------------------- History & Exports ------------------- */
function renderHistory(){
  const tbody = document.getElementById("historyTable");
  if (!tbody) return;
  tbody.innerHTML = history.map((h, idx) => `
    <tr class="border-b">
      <td class="p-2">${escapeHtml(h.name)}</td>
      <td class="p-2">${escapeHtml(h.matric)}</td>
      <td class="p-2">${escapeHtml(h.year)}</td>
      <td class="p-2">${escapeHtml(h.feeType)}</td>
      <td class="p-2">₦${Number(h.amount).toLocaleString()}</td>
      <td class="p-2">${new Date(h.date).toLocaleString()}</td>
      <td class="p-2">${escapeHtml(h.reference || "-")}</td>
      <td class="p-2"><button onclick="downloadStoredReceipt('${escapeHtml(h.reference)}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Download Receipt</button></td>
    </tr>`).join("");
}

async function downloadStoredReceipt(reference) {
  try {
    // look in guest_payments and user's payments
    let url = null;
    if (currentUser && currentUser.uid) {
      const q = query(collection(db, "users", currentUser.uid, "payments"), where("reference", "==", reference), limit(1));
      const snap = await getDocs(q);
      if (!snap.empty) url = snap.docs[0].data().receiptUrl;
    }
    if (!url) {
      const q2 = query(collection(db, "guest_payments"), where("reference", "==", reference), limit(1));
      const snap2 = await getDocs(q2);
      if (!snap2.empty) url = snap2.docs[0].data().receiptUrl;
    }
    if (url) window.open(url, "_blank");
    else alert("Receipt not found. It may take a few moments after payment to become available.");
  } catch (e) {
    console.error(e);
    alert("Error fetching receipt.");
  }
}

function filterHistory(){
  const q = (document.getElementById("searchHistory")?.value || "").toLowerCase().trim();
  const filtered = history.filter(h =>
    (h.name || "").toLowerCase().includes(q) ||
    (h.matric || "").toLowerCase().includes(q) ||
    String(h.year).includes(q) ||
    ((h.reference || "").toLowerCase().includes(q))
  );
  const tbody = document.getElementById("historyTable");
  if (!tbody) return;
  tbody.innerHTML = filtered.map((h, idx) => `
    <tr class="border-b">
      <td class="p-2">${escapeHtml(h.name)}</td>
      <td class="p-2">${escapeHtml(h.matric)}</td>
      <td class="p-2">${escapeHtml(h.year)}</td>
      <td class="p-2">${escapeHtml(h.feeType)}</td>
      <td class="p-2">₦${Number(h.amount).toLocaleString()}</td>
      <td class="p-2">${new Date(h.date).toLocaleString()}</td>
      <td class="p-2">${escapeHtml(h.reference || "-")}</td>
      <td class="p-2"><button onclick="downloadStoredReceipt('${escapeHtml(h.reference)}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Download Receipt</button></td>
    </tr>`).join("");
}
window.filterHistory = filterHistory;

function downloadHistoryPDF(){
  if (!history.length) return alert("No history to export.");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const margin = 40;
  let y = 40;
  doc.setFontSize(16);
  doc.text("PTS Payment History", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
  y += 30;
  doc.setFontSize(10);
  history.forEach(h => {
    const line = `${new Date(h.date).toLocaleString()} | ${h.name} | ${h.matric} | ${h.feeType} | ₦${Number(h.amount).toLocaleString()} | Ref: ${h.reference || "-"}`;
    doc.text(line, margin, y);
    y += 14;
    if (y > doc.internal.pageSize.getHeight() - 60) {
      doc.addPage();
      y = 40;
    }
  });
  doc.save("PTS_Payment_History.pdf");
}
window.downloadHistoryPDF = downloadHistoryPDF;

function downloadHistoryExcel(){
  if (!history.length) return alert("No history available");
  try {
    const worksheetData = history.map(h => ({
      Date: new Date(h.date).toLocaleString(),
      Name: h.name,
      Matric: h.matric,
      Year: h.year,
      FeeType: h.feeType,
      Amount: h.amount,
      Reference: h.reference || "-"
    }));
    const ws = XLSX.utils.json_to_sheet(worksheetData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "History");
    XLSX.writeFile(wb, "PTS_Payment_History.xlsx");
  } catch (err) {
    console.error(err);
    alert("❌ Excel export failed.");
  }
}
window.downloadHistoryExcel = downloadHistoryExcel;

function clearHistory(){
  if (!confirm("Clear local payment history? This will remove local entries.")) return;
  history = [];
  localStorage.removeItem("paymentHistory");
  renderHistory();
  updateSummary();
  renderChart();
}
window.clearHistory = clearHistory;

/* ------------------- Summary & Chart ------------------- */
function updateSummary() {
  let total = 0, dept = 0, school = 0;
  history.forEach(h => {
    const amt = Number(h.amount) || 0;
    total += amt;
    const ft = (h.feeType || "").toLowerCase();
    if (ft.includes("department")) dept += amt;
    if (ft.includes("association") || ft.includes("school")) school += amt;
  });
  const totalEl = document.getElementById("totalPayments");
  const deptEl = document.getElementById("totalDept");
  const schoolEl = document.getElementById("totalSchool");
  if (totalEl) totalEl.innerText = "₦" + total.toLocaleString();
  if (deptEl) deptEl.innerText = "₦" + dept.toLocaleString();
  if (schoolEl) schoolEl.innerText = "₦" + school.toLocaleString();
}

let myChart = null;
function renderChart(){
  const canvas = document.getElementById("paymentChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const deptTotal = history.filter(h => (h.feeType || "").toLowerCase().includes("department")).reduce((s, r) => s + Number(r.amount), 0);
  const schoolTotal = history.filter(h => (h.feeType || "").toLowerCase().includes("association") || (h.feeType || "").toLowerCase().includes("school")).reduce((s, r) => s + Number(r.amount), 0);
  const other = history.reduce((s, r) => s + Number(r.amount), 0) - deptTotal - schoolTotal;

  if (myChart) myChart.destroy();
  myChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Departmental", "Association/School", "Other"],
      datasets: [{ data: [deptTotal, schoolTotal, other], backgroundColor: ["#34d399","#8b5cf6","#f59e0b"] }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
  });
}

/* ------------------- Profile helpers ------------------- */
function saveProfile(){
  const p = {
    name: (document.getElementById("profileName")?.value || "").trim(),
    matric: (document.getElementById("profileMatric")?.value || "").trim(),
    email: (document.getElementById("profileEmail")?.value || "").trim()
  };
  localStorage.setItem("studentProfile", JSON.stringify(p));
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = p.name || "Not signed in";
  if (p.name) document.getElementById("studentName").value = p.name;
  if (p.matric) document.getElementById("studentMatric").value = p.matric;
  showNotification("Profile saved locally.");
}

function loadProfile(){
  const p = JSON.parse(localStorage.getItem("studentProfile") || "null");
  if (!p) return;
  if (document.getElementById("profileName")) document.getElementById("profileName").value = p.name || "";
  if (document.getElementById("profileMatric")) document.getElementById("profileMatric").value = p.matric || "";
  if (document.getElementById("profileEmail")) document.getElementById("profileEmail").value = p.email || "";
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = p.name || "Not signed in";
  if (document.getElementById("studentName")) document.getElementById("studentName").value = p.name || "";
  if (document.getElementById("studentMatric")) document.getElementById("studentMatric").value = p.matric || "";
}

/* logout local profile */
function logoutProfile(){
  localStorage.removeItem("studentProfile");
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = "Not signed in";
  showNotification("Logged out (local profile cleared).");
}

/* ------------------- Utilities ------------------- */
function escapeHtml(s){ if (!s) return ""; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* ------------------- Admin: load all payments ------------------- */
async function loadAllPaymentsForAdmin() {
  // Only show if current user's email is in ADMIN_EMAILS (client-side check; enforce with security rules)
  const profile = JSON.parse(localStorage.getItem("studentProfile") || "null") || {};
  const email = profile.email || "";
  if (!ADMIN_EMAILS.includes(email)) {
    alert("Admin access required. Set profile email to an admin email to view.");
    return;
  }
  try {
    const adminBody = document.getElementById("adminTableBody");
    adminBody.innerHTML = "<tr><td colspan='8' class='p-4'>Loading...</td></tr>";
    // fetch guest_payments and all user subcollections (simple approach: guest_payments + top-level query)
    const guestSnap = await getDocs(collection(db, "guest_payments"));
    const userPayments = [];
    // Note: collecting all user payments requires a Firestore collection group query on "payments" if structured that way.
    // For simplicity, query collection group:
    const paymentsGroup = await getDocs(query(collection(db, "guest_payments"), orderBy("createdAt", "desc")));
    // show guest payments first
    let rows = [];
    guestSnap.forEach(docSnap => {
      const d = docSnap.data();
      rows.push(d);
    });

    // try collection group if your Firestore has "payments" subcollections
    try {
      // eslint-disable-next-line no-undef
      const groupQuery = await getDocs(query((collection(db, "payments")), orderBy("createdAt", "desc")));
      // If your Firestore doesn't have a top-level "payments" collection, this may fail.
      groupQuery.forEach(snap => rows.push(snap.data()));
    } catch (e) {
      // ignore - different Firestore structure
    }

    // fallback: just show guest payments
    adminBody.innerHTML = rows.map(r => `
      <tr class="border-b">
        <td class="p-2">${new Date(r.date).toLocaleString()}</td>
        <td class="p-2">${escapeHtml(r.name)}</td>
        <td class="p-2">${escapeHtml(r.matric)}</td>
        <td class="p-2">${escapeHtml(r.year)}</td>
        <td class="p-2">${escapeHtml(r.feeType)}</td>
        <td class="p-2">₦${Number(r.amount).toLocaleString()}</td>
        <td class="p-2">${escapeHtml(r.reference)}</td>
        <td class="p-2"><a class="text-indigo-600" href="${escapeHtml(r.receiptUrl || '#')}" target="_blank">Receipt</a></td>
      </tr>
    `).join("") || "<tr><td colspan='8' class='p-4'>No payments found.</td></tr>";
  } catch (err) {
    console.error(err);
    alert("Error loading admin payments. Check console.");
  }
}

/* export admin CSV (basic) */
function exportAdminCSV() {
  // export local history as CSV
  if (!history.length) return alert("No payments to export.");
  const rows = [["Date","Name","Matric","Year","FeeType","Amount","Reference"]];
  history.forEach(h => rows.push([new Date(h.date).toLocaleString(), h.name, h.matric, h.year, h.feeType, h.amount, h.reference]));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "PTS_All_Payments.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ------------------- Auth: sign in anonymously & handler ------------------- */
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    console.log("Signed in:", user.uid, "Anonymous:", user.isAnonymous);
    // check if profile email is admin
    const profile = JSON.parse(localStorage.getItem("studentProfile") || "null") || {};
    if (ADMIN_EMAILS.includes(profile.email || "")) {
      document.getElementById("navAdminLi").classList.remove("hidden");
      document.getElementById("userRoleDisplay").innerText = "Admin";
      document.getElementById("navAdminLi").style.display = "";
    } else {
      document.getElementById("navAdminLi").classList.add("hidden");
      document.getElementById("userRoleDisplay").innerText = "User";
    }
  } else {
    // sign in anonymously if no user
    signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
  }
});

/* ------------------- Init on DOMContentLoaded ------------------- */
document.addEventListener("DOMContentLoaded", () => {
  ensureNavButtons();
  showSection("dashboard");
  renderHistory();
  updateSummary();
  renderChart();
  loadProfile();

  document.getElementById("studentYear")?.addEventListener("change", updateFees);
  document.getElementById("paymentType")?.addEventListener("change", updateFees);

  // menu toggle for mobile also bound earlier
});

/* ------------------- Paystack Webhook (server-side guidance) -------------------
  IMPORTANT: To fully secure payments you must verify Paystack webhooks server-side.

  Example Paystack webhook verification (Node.js / Cloud Functions):
  const crypto = require('crypto');
  exports.paystackWebhook = functions.https.onRequest((req, res) => {
    const hash = crypto.createHmac('sha512', YOUR_PAYSTACK_SECRET).update(JSON.stringify(req.body)).digest('hex');
    if (hash === req.headers['x-paystack-signature']) {
      // trusted - process event
    } else {
      res.status(400).send('Invalid signature');
    }
  });

  Use the webhook to mark payments as VERIFIED on your Firestore documents and to
  send email receipts from server-side (recommended).
------------------------------------------------------------------------- */

</script>
</body>
</html>
