<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTS Payment Dashboard</title>

  <!-- Tailwind (dev/demo only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for receipts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Paystack inline (make sure reachable) -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <style>
    .receipt-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; white-space: pre-wrap; }
    .nav-active { background-color: rgba(255,255,255,0.06); }
    .sr-only {position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-sm min-h-screen">

<!-- Layout -->
<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-sky-800 text-white p-6 hidden md:block">
    <div class="flex items-center gap-3 mb-6">
      <img id="logoSmall" src="" alt="PTS" class="w-12 h-12 object-contain bg-white/10 rounded p-1"/>
      <div>
        <h2 class="text-xl font-bold">PTS Payments</h2>
        <div id="userRoleDisplay" class="text-xs opacity-80">Guest</div>
      </div>
    </div>
    <nav id="navList" class="space-y-2">
      <button id="navDashboard" class="w-full text-left px-3 py-2 rounded hover:bg-sky-700">üè† Dashboard</button>
      <button id="navPayment" class="w-full text-left px-3 py-2 rounded hover:bg-sky-700">üí≥ Make Payment</button>
      <button id="navHistory" class="w-full text-left px-3 py-2 rounded hover:bg-sky-700">üìú History</button>
      <button id="navProfile" class="w-full text-left px-3 py-2 rounded hover:bg-sky-700">üë§ Profile</button>
      <button id="navAdmin" class="w-full text-left px-3 py-2 rounded hover:bg-sky-700 hidden">üìä Admin</button>
      <button id="navSettings" class="w-full text-left px-3 py-2 rounded hover:bg-sky-700">‚öô Settings</button>
    </nav>

    <div class="mt-6 space-y-2">
      <button id="adminLoginBtn" class="w-full bg-indigo-600 py-2 rounded">üîí Admin</button>
      <button id="darkToggle" class="w-full bg-sky-600 py-2 rounded">üåô Theme</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <img id="logoHeader" src="" alt="PTS" class="h-12 w-12 object-contain bg-white/5 rounded p-1"/>
        <div>
          <h1 class="text-2xl font-bold text-sky-800 dark:text-white">PTS Payment Dashboard</h1>
          <div id="userNameDisplay" class="text-xs text-slate-600 dark:text-slate-300">Not signed in</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="menuToggle" class="md:hidden px-3 py-2 bg-sky-700 text-white rounded">‚ò∞</button>
        <div class="text-right">
          <div id="quickTotals" class="text-xs">Local payments: <span id="localCount">0</span></div>
        </div>
      </div>
    </header>

    <!-- Notification -->
    <div id="notification" class="hidden p-3 rounded mb-4" role="status" aria-live="polite"></div>

    <!-- Sections -->
    <section id="dashboardSection">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="p-4 bg-white rounded shadow">
          <h3 class="text-xs text-gray-500">Total Collected</h3>
          <div id="totalPayments" class="text-2xl font-bold">‚Ç¶0</div>
        </div>
        <div class="p-4 bg-white rounded shadow">
          <h3 class="text-xs text-gray-500">Department</h3>
          <div id="totalDept" class="text-2xl font-bold">‚Ç¶0</div>
        </div>
        <div class="p-4 bg-white rounded shadow">
          <h3 class="text-xs text-gray-500">Association</h3>
          <div id="totalAssoc" class="text-2xl font-bold">‚Ç¶0</div>
        </div>
      </div>

      <div class="bg-white p-4 rounded shadow mb-4">
        <h3 class="font-semibold mb-2">Payment Overview</h3>
        <div class="h-56">
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </section>

    <section id="paymentSection" class="hidden">
      <div class="bg-white p-6 rounded shadow">
        <h2 class="font-bold text-lg mb-4">Make Payment</h2>

        <form id="paymentForm" class="space-y-3" onsubmit="event.preventDefault(); makePayment();">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="studentName" placeholder="Full Name" class="border p-2 rounded" required />
            <input id="studentMatric" placeholder="Matric Number" class="border p-2 rounded" required />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <select id="studentYear" class="border p-2 rounded" onchange="updateFees()" required>
              <option value="">-- Year --</option>
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
            </select>

            <select id="paymentType" class="border p-2 rounded" onchange="updateFees()">
              <option value="All">All</option>
              <option>Course enrollment</option>
              <option>I.T fee</option>
              <option>Departmental dues</option>
              <option>Practical fee</option>
              <option>Project fee</option>
            </select>
          </div>

          <div id="feeBreakdown" class="bg-slate-50 p-3 rounded receipt-mono text-xs"></div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
            <input id="totalAmount" readonly class="border p-2 rounded" />
            <div class="flex gap-2">
              <button id="payNowBtn" class="bg-sky-700 text-white px-4 py-2 rounded flex items-center gap-2" type="submit">
                <span id="payNowLabel">Pay Now</span>
                <svg id="paySpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
              </button>
              <button id="previewReceiptBtn" type="button" class="bg-gray-200 px-3 py-2 rounded">Preview</button>
            </div>
          </div>
        </form>
      </div>
    </section>

    <section id="historySection" class="hidden">
      <div class="bg-white p-4 rounded shadow mb-4">
        <div class="flex gap-2 items-center">
          <input id="searchHistory" placeholder="Search name/matric/ref..." class="border p-2 rounded flex-1" oninput="filterHistory()" />
          <button onclick="downloadHistoryPDF()" class="bg-sky-700 text-white px-3 py-2 rounded">PDF</button>
          <button onclick="downloadHistoryExcel()" class="bg-green-600 text-white px-3 py-2 rounded">Excel</button>
          <button onclick="exportAdminCSV()" class="bg-indigo-600 text-white px-3 py-2 rounded">CSV</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <table class="w-full text-sm">
          <thead class="text-left text-xs text-gray-500">
            <tr><th>Name</th><th>Matric</th><th>Year</th><th>Type</th><th>Amount</th><th>Date</th><th>Ref</th><th>Action</th></tr>
          </thead>
          <tbody id="historyTable" class="text-xs"></tbody>
        </table>
      </div>
    </section>

    <section id="profileSection" class="hidden">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">Student Profile</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <input id="profileName" placeholder="Full name" class="border p-2 rounded" />
          <input id="profileMatric" placeholder="Matric number" class="border p-2 rounded" />
          <input id="profileEmail" placeholder="Email" class="border p-2 rounded" />
        </div>

        <div class="mt-3 flex gap-2">
          <button id="saveProfileBtn" class="bg-purple-700 text-white px-4 py-2 rounded">Save Profile</button>
          <label class="flex items-center gap-2"><input id="autoSaveProfile" type="checkbox"/> Auto-save</label>
        </div>
      </div>
    </section>

    <section id="adminSection" class="hidden">
      <div class="bg-white p-4 rounded shadow mb-4">
        <div class="flex gap-2">
          <button id="refreshAllPayments" class="bg-sky-700 text-white px-3 py-2 rounded">Refresh</button>
          <button id="downloadAllReceipts" class="bg-indigo-600 text-white px-3 py-2 rounded">Download Receipts</button>
        </div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <table class="w-full text-sm">
          <thead class="text-left text-xs text-gray-500">
            <tr><th>Date</th><th>Name</th><th>Matric</th><th>Year</th><th>Type</th><th>Amount</th><th>Ref</th><th>Receipt</th></tr>
          </thead>
          <tbody id="adminTableBody" class="text-xs"></tbody>
        </table>
      </div>
    </section>

    <section id="settingsSection" class="hidden">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Settings & Department Value Adds</h3>
        <ul class="list-disc pl-6">
          <li>Export summary reports by month / year (CSV & Excel) ‚Äî useful for reconciliations.</li>
          <li>Auto-email receipts to students (requires cloud function).</li>
          <li>Webhook to verify payments server-side and mark receipts saved (recommended).</li>
          <li>Download receipts in bulk (server-side zip recommended for production).</li>
        </ul>
      </div>
    </section>
  </main>
</div>

<!-- Admin Modal (client-side) -->
<div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white p-4 rounded w-96">
    <h3 class="font-semibold mb-2">Admin Access (demo)</h3>
    <input id="adminPasswordInput" type="password" class="border p-2 rounded w-full mb-3" placeholder="Enter admin password" />
    <div class="flex justify-end gap-2">
      <button id="adminLoginCancel" class="px-3 py-1 rounded bg-gray-200">Cancel</button>
      <button id="adminLoginSubmit" class="px-3 py-1 rounded bg-indigo-600 text-white">Login</button>
    </div>
    <p id="adminLoginMsg" class="text-xs text-red-600 mt-2 hidden"></p>
  </div>
</div>

<!-- Receipt Preview Modal -->
<div id="receiptModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-40">
  <div class="bg-white p-4 rounded w-11/12 max-w-2xl">
    <div class="flex justify-between items-start">
      <h3 class="font-semibold">Receipt Preview</h3>
      <div class="flex gap-2">
        <button id="printReceiptBtn" class="px-2 py-1 bg-sky-700 text-white rounded">Print</button>
        <button id="closeReceiptBtn" class="px-2 py-1 bg-gray-200 rounded">Close</button>
      </div>
    </div>
    <div id="receiptContent" class="mt-3 receipt-mono text-xs"></div>
  </div>
</div>

<!-- Main script (module) -->
<script type="module">
/* -------------------------------
  World-class PTS dashboard (client)
  - Single-file, module-based JS
  - Replace firebase config, Paystack keys for production
  - IMPORTANT: secure server-side verification and Firestore rules
---------------------------------*/

/* ---------- CONFIG ---------- */
const PAYSTACK_PUBLIC_KEY = "pk_live_258fa9605c51c7f7a1f5c20e0254ddf80671d878"; // replace
const PAYSTACK_SPLIT_CODE = "SPL_Ijp4pkn553"; // replace if needed

/* Firebase imports (modular) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

/* ---------- Firebase config (replace with your project) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBzuQuY_9BSGrhQmN2zuH7bgS8nUOBZRnA",
  authDomain: "pts-bscht.firebaseapp.com",
  projectId: "pts-bscht",
  storageBucket: "pts-bscht.firebasestorage.app",
  messagingSenderId: "860500545291",
  appId: "1:860500545291:web:60df69992bcaddcb0bdc0e",
  measurementId: "G-B9NTEZYFMM"
};

/* ---------- Initialize libs ---------- */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const functions = getFunctions(app);

/* ---------- Local state ---------- */
let history = JSON.parse(localStorage.getItem("paymentHistory")|| "[]");
let profile = JSON.parse(localStorage.getItem("studentProfile")|| "null") || null;
let currentUser = null;
let authDisabled = false;
const ADMIN_PASSWORD = "Admin@1234"; // demo only: secure on server for production

/* ---------- DOM helpers ---------- */
const $ = id => document.getElementById(id);
const announce = (msg, tone="info") => {
  const n = $("notification");
  n.innerText = msg;
  n.className = "p-3 rounded mb-4 " + (tone==="error" ? "bg-red-100 text-red-700" : "bg-yellow-100 text-yellow-900");
  n.classList.remove("hidden");
  setTimeout(()=> n.classList.add("hidden"), 4000);
};
const escapeHtml = s => (s||"").toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));

/* ---------- Fees data ---------- */
const feesTable = {
  1: { "Course enrollment": 200, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  2: { "Course enrollment": 1000, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  3: { "Course enrollment": 1000, "Departmental dues": 6000, "Practical fee": 4000, "Project fee": 15000 }
};

/* ---------- Utility: update fees UI ---------- */
function updateFees(){
  const year = $("studentYear")?.value;
  const type = $("paymentType")?.value || "All";
  const breakdown = $("feeBreakdown");
  if(!breakdown) return;
  breakdown.innerHTML = "";
  if(!year){ $("totalAmount").value = ""; return; }
  const items = feesTable[year] || {};
  let total = 0, html = "";
  Object.entries(items).forEach(([k,v])=>{
    if(type==="All" || type===k) { html += `<div class="flex justify-between"><span>${k}</span><span>‚Ç¶${v.toLocaleString()}</span></div>`; total += (type==="All"? v : (type===k ? v:0)); }
  });
  breakdown.innerHTML = html + `<hr class="my-2"><div class="flex justify-between font-bold"><div>Total</div><div>‚Ç¶${total.toLocaleString()}</div></div>`;
  $("totalAmount").value = total;
}
window.updateFees = updateFees;

/* ---------- Chart rendering ---------- */
let myChart = null;
function renderChart(){
  try {
    const ctx = $("paymentChart")?.getContext("2d");
    if(!ctx) return;
    const dept = history.filter(h=> (h.feeType||"").toLowerCase().includes("department")).reduce((s,r)=>s+Number(r.amount),0);
    const assoc = history.filter(h=> (h.feeType||"").toLowerCase().includes("association") || (h.feeType||"").toLowerCase().includes("school")).reduce((s,r)=>s+Number(r.amount),0);
    const other = Math.max(0, history.reduce((s,r)=>s+Number(r.amount),0) - dept - assoc);
    if(window.Chart){
      if(myChart) myChart.destroy();
      myChart = new Chart(ctx, { type:"doughnut", data:{ labels:["Departmental","Association","Other"], datasets:[{ data:[dept,assoc,other] }] }, options:{ responsive:true, maintainAspectRatio:false }});
    }
  } catch(e){ console.warn("chart", e); }
}
window.renderChart = renderChart;

/* ---------- Render history table ---------- */
function renderHistory(){
  const tbody = $("historyTable");
  if(!tbody) return;
  if(!history.length){
    tbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">No payments yet</td></tr>`;
    $("localCount").innerText = "0";
    return;
  }
  tbody.innerHTML = history.slice().reverse().map(h => {
    return `<tr class="border-b">
      <td class="p-2">${escapeHtml(h.name)}</td>
      <td class="p-2">${escapeHtml(h.matric)}</td>
      <td class="p-2">${escapeHtml(h.year)}</td>
      <td class="p-2">${escapeHtml(h.feeType)}</td>
      <td class="p-2">‚Ç¶${Number(h.amount).toLocaleString()}</td>
      <td class="p-2">${new Date(h.date).toLocaleString()}</td>
      <td class="p-2">${escapeHtml(h.reference)}</td>
      <td class="p-2 flex gap-2">
        <button onclick="copyRef('${escapeHtml(h.reference)}')" class="px-2 py-1 bg-gray-200 rounded text-xs">Copy</button>
        <button onclick="downloadStoredReceipt('${escapeHtml(h.reference)}')" class="px-2 py-1 bg-sky-700 text-white rounded text-xs">Receipt</button>
      </td>
    </tr>`;
  }).join("");
  $("localCount").innerText = history.length;
}
window.renderHistory = renderHistory;

/* ---------- Copy ref ---------- */
window.copyRef = (ref) => navigator.clipboard?.writeText(ref).then(()=>announce("Reference copied"))?.catch(()=>announce("Copy failed", "error"));

/* ---------- Receipt fetcher (best-effort) ---------- */
async function downloadStoredReceipt(reference){
  try{
    announce("Fetching receipt (best-effort)...");
    let url = null;
    const q1 = query(collection(db, "guest_payments"), where("reference","==", reference), limit(1));
    const s1 = await getDocs(q1);
    if(!s1.empty) url = s1.docs[0].data().receiptUrl;
    if(!url){
      try{
        const q2 = query(collection(db, "payments"), where("reference","==", reference), limit(1));
        const s2 = await getDocs(q2);
        if(!s2.empty) url = s2.docs[0].data().receiptUrl;
      }catch(e){}
    }
    if(url) window.open(url, "_blank");
    else announce("Receipt not found (might be uploaded later).", "error");
  }catch(e){ console.error(e); announce("Error fetching receipt", "error"); }
}
window.downloadStoredReceipt = downloadStoredReceipt;

/* ---------- Receipt generation (jsPDF) ---------- */
async function generateReceiptPDF(record, returnBlob=false){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 40;
  let y = 40;
  doc.setFontSize(18); doc.text("PTS Payment Receipt", pageW - margin, y+18, { align:"right" });
  y+=60;
  doc.setFontSize(10);
  doc.text(`Date: ${new Date(record.date).toLocaleString()}`, margin, y);
  doc.text(`Ref: ${record.reference}`, pageW - margin, y, { align:"right" });
  y+=28;
  doc.rect(margin, y, pageW - margin*2, 120, "S");
  let boxY = y + 20;
  doc.setFontSize(11);
  doc.text("Student Name:", margin+12, boxY); doc.text(record.name||"-", pageW/2, boxY); boxY+=18;
  doc.text("Matric:", margin+12, boxY); doc.text(record.matric||"-", pageW/2, boxY); boxY+=18;
  doc.text("Year:", margin+12, boxY); doc.text(String(record.year||"-"), pageW/2, boxY); boxY+=18;
  doc.text("Fee Type:", margin+12, boxY); doc.text(String(record.feeType||"-"), pageW/2, boxY); boxY+=18;
  doc.text("Amount:", margin+12, boxY); doc.text(`‚Ç¶${Number(record.amount).toLocaleString()}`, pageW/2, boxY); boxY+=18;
  y += 160;
  doc.setFontSize(9);
  const note = "Autogenerated receipt. Verify with official payment reference.";
  doc.text(doc.splitTextToSize(note, pageW - margin*2), margin, y);
  const filename = `Receipt_${(record.matric||'unk')}_${record.reference}.pdf`;
  if(returnBlob){
    return { blob: doc.output("blob"), filename };
  } else {
    doc.save(filename);
  }
}
window.generateReceiptPDF = generateReceiptPDF;

/* ---------- Auth: anonymous sign-in fallback ---------- */
onAuthStateChanged(auth, (user)=>{
  if(user){ currentUser = user; console.log("auth:", user.uid); }
  else{
    signInAnonymously(auth).catch(err=>{
      console.warn("anon sign-in failed:", err); authDisabled = true; announce("Firebase anonymous auth disabled ‚Äî running local-only.");
    });
  }
});

/* ---------- Payment flow (Paystack inline) ---------- */
function setPaySpinner(on){
  $("paySpinner")?.classList.toggle("hidden", !on);
  $("payNowLabel").innerText = on ? "Processing..." : "Pay Now";
  $("payNowBtn").disabled = on;
}

function makeReference(){
  // unique ID: PTS-<timestamp>-<4 random hex>
  const t = Date.now().toString(36);
  const r = Math.floor(Math.random()*0xffff).toString(16).padStart(4,"0");
  return `PTS-${t}-${r}`;
}

async function makePayment(){
  try{
    const name = ($("studentName")?.value||"").trim();
    const matric = ($("studentMatric")?.value||"").trim();
    const year = ($("studentYear")?.value||"").trim();
    const amount = Number($("totalAmount")?.value || 0);
    const feeType = ($("paymentType")?.value || "All");
    const emailFromProfile = (profile && profile.email) ? profile.email : ($("profileEmail")?.value||"").trim();
    const email = emailFromProfile || `${matric}@pts.edu.ng`;

    if(!name || !matric || !year || amount<=0) return alert("Fill all fields and ensure amount > 0");

    // check Paystack inline loaded
    const PaystackGlobal = window.PaystackPop || window.paystackpop || window.Paystack || null;
    if(!PaystackGlobal || typeof PaystackGlobal.setup !== "function"){ return alert("Paystack inline library not loaded"); }

    setPaySpinner(true);

    const reference = makeReference();
    const handler = PaystackGlobal.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email,
      amount: Math.round(amount*100),
      currency: "NGN",
      ref: reference,
      split_code: PAYSTACK_SPLIT_CODE,
      metadata: {
        custom_fields: [
          { display_name: "Student Name", variable_name: "student_name", value: name },
          { display_name: "Matric No", variable_name: "matric", value: matric }
        ]
      },
      callback: async (res) => {
        // success - record & persist
        try{
          const rec = {
            name, matric, year, feeType, amount, date: new Date().toISOString(),
            reference: res.reference || reference, status: "SUCCESS", payerEmail: email, createdAt: serverTimestamp()
          };
          // save locally
          history.push(rec);
          localStorage.setItem("paymentHistory", JSON.stringify(history));
          renderHistory(); renderChart(); updateSummary();

          // attempt Firestore save (best-effort)
          try{
            const docRef = await addDoc(collection(db, currentUser && currentUser.uid ? `users/${currentUser.uid}/payments` : "guest_payments"), rec);
            // generate and upload receipt blob
            try{
              const { blob, filename } = await generateReceiptPDF(rec, true);
              const path = `receipts/${docRef.id}/${filename}`;
              const sRef = storageRef(storage, path);
              await uploadBytes(sRef, blob);
              const receiptUrl = await getDownloadURL(sRef);
              await setDoc(doc(db, docRef.parent.path, docRef.id), { receiptUrl }, { merge: true });
            }catch(upErr){ console.warn("receipt upload failed", upErr); }
            // optional send email via cloud function
            try{ const sendReceipt = httpsCallable(functions, "sendReceiptEmail"); await sendReceipt({ email: rec.payerEmail, name: rec.name, reference: rec.reference }); }catch(e){console.warn("sendReceiptEmail:", e);}
          }catch(dbErr){
            console.warn("Save to Firestore failed (maybe rules). Local-only:", dbErr);
          }

          setPaySpinner(false);
          announce("Payment successful ‚Äî Ref: " + (res.reference || reference));
        }catch(err){
          console.error("callback err", err); setPaySpinner(false); announce("Post-processing failed", "error");
        }
      },
      onClose: () => { setPaySpinner(false); announce("Payment closed"); }
    });

    try{ handler.openIframe(); }catch(e){ console.error(e); setPaySpinner(false); alert("Payment window could not open"); }
  }catch(err){ console.error("makePayment error", err); setPaySpinner(false); alert("Unexpected error"); }
}
window.makePayment = makePayment;

/* ---------- Save profile ---------- */
function saveProfile(){
  const name = ($("profileName")?.value||"").trim();
  const matric = ($("profileMatric")?.value||"").trim();
  const email = ($("profileEmail")?.value||"").trim();
  if(!name || !matric || !email) return alert("Please fill all profile fields");
  profile = { name, matric, email };
  localStorage.setItem("studentProfile", JSON.stringify(profile));
  // autofill form
  $("studentName").value = name;
  $("studentMatric").value = matric;
  $("userNameDisplay").innerText = name;
  $("userRoleDisplay").innerText = "Student";
  announce("Profile saved");
}
$("saveProfileBtn")?.addEventListener("click", saveProfile);
window.saveProfile = saveProfile;

/* Auto-load profile on start */
function loadProfileToUI(){
  const saved = localStorage.getItem("studentProfile");
  if(saved){ profile = JSON.parse(saved); $("profileName").value = profile.name || ""; $("profileMatric").value = profile.matric || ""; $("profileEmail").value = profile.email || ""; $("studentName").value = profile.name || ""; $("studentMatric").value = profile.matric || ""; $("userNameDisplay").innerText = profile.name || "Not signed in"; }
}
loadProfileToUI();

/* Auto-save toggle */
$("autoSaveProfile")?.addEventListener("change", (e)=>{
  if(e.target.checked) {
    // attach input listeners
    ["profileName","profileMatric","profileEmail"].forEach(id=>{
      $(id)?.addEventListener("input", () => {
        const n = $("profileName")?.value.trim(), m = $("profileMatric")?.value.trim(), em = $("profileEmail")?.value.trim();
        if(n && m && em){ profile = { name:n, matric:m, email:em }; localStorage.setItem("studentProfile", JSON.stringify(profile)); announce("Profile auto-saved"); }
      });
    });
  }
});

/* ---------- Preview receipt (near Pay Now) ---------- */
$("previewReceiptBtn")?.addEventListener("click", ()=>{
  const name = ($("studentName")?.value||"").trim();
  const matric = ($("studentMatric")?.value||"").trim();
  const year = ($("studentYear")?.value||"").trim();
  const type = ($("paymentType")?.value||"").trim();
  const amount = ($("totalAmount")?.value||"").trim();
  if(!name || !matric || !year || !amount) return alert("Fill payment fields first to preview.");
  const receiptHtml = `
    <div class="text-center mb-3">
      <h2 class="text-lg font-bold">PTS PAYMENT RECEIPT (PREVIEW)</h2>
      <div class="text-xs text-gray-500">Not official until payment completes</div>
    </div>
    <div class="space-y-1 text-xs">
      <div><b>Name:</b> ${escapeHtml(name)}</div>
      <div><b>Matric:</b> ${escapeHtml(matric)}</div>
      <div><b>Year:</b> ${escapeHtml(year)}</div>
      <div><b>Fee Type:</b> ${escapeHtml(type)}</div>
      <div><b>Amount:</b> ‚Ç¶${Number(amount).toLocaleString()}</div>
      <div><b>Date:</b> ${new Date().toLocaleString()}</div>
    </div>`;
  $("receiptContent").innerHTML = receiptHtml;
  $("receiptModal").classList.remove("hidden");
});
$("closeReceiptBtn")?.addEventListener("click", ()=> $("receiptModal").classList.add("hidden"));
$("printReceiptBtn")?.addEventListener("click", ()=>{
  const w = window.open("", "_blank");
  w.document.write(`<pre style="font-family:monospace">${$("receiptContent").innerText}</pre>`);
  w.print(); w.close();
});

/* ---------- Exports ---------- */
function exportAdminCSV(){
  if(!history.length) return alert("No payments");
  const rows = [["Date","Name","Matric","Year","FeeType","Amount","Reference"]];
  history.forEach(h=> rows.push([new Date(h.date).toLocaleString(), h.name, h.matric, h.year, h.feeType, h.amount, h.reference]));
  const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "payments.csv"; a.click(); URL.revokeObjectURL(url);
}
window.exportAdminCSV = exportAdminCSV;

function downloadHistoryPDF(){
  if(!history.length) return alert("No data");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  let y = 40; doc.setFontSize(16); doc.text("PTS Payments History", 40, y); y+=30; doc.setFontSize(10);
  history.slice().reverse().forEach(h=>{
    doc.text(`${new Date(h.date).toLocaleString()} | ${h.name} | ${h.matric} | ${h.feeType} | ‚Ç¶${h.amount} | ${h.reference}`, 40, y);
    y+=14; if(y>770){ doc.addPage(); y=40; }
  });
  doc.save("history.pdf");
}
window.downloadHistoryPDF = downloadHistoryPDF;

function downloadHistoryExcel(){
  if(!history.length) return alert("No data");
  const worksheet = history.map(h=>({ Date: new Date(h.date).toLocaleString(), Name:h.name, Matric:h.matric, Year:h.year, FeeType:h.feeType, Amount:h.amount, Reference:h.reference }));
  const ws = XLSX.utils.json_to_sheet(worksheet);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Payments");
  XLSX.writeFile(wb, "payments.xlsx");
}
window.downloadHistoryExcel = downloadHistoryExcel;

/* ---------- Summary totals ---------- */
function updateSummary(){
  const total = history.reduce((s,r)=> s + Number(r.amount || 0), 0);
  const dept = history.filter(h=> (h.feeType||"").toLowerCase().includes("department")).reduce((s,r)=>s+Number(r.amount),0);
  const assoc = history.filter(h=> (h.feeType||"").toLowerCase().includes("association") || (h.feeType||"").toLowerCase().includes("school")).reduce((s,r)=>s+Number(r.amount),0);
  $("totalPayments").innerText = "‚Ç¶" + total.toLocaleString();
  $("totalDept").innerText = "‚Ç¶" + dept.toLocaleString();
  $("totalAssoc").innerText = "‚Ç¶" + assoc.toLocaleString();
}
window.updateSummary = updateSummary;

/* ---------- Filter history ---------- */
function filterHistory(){
  const q = ($("searchHistory")?.value||"").toLowerCase().trim();
  const filtered = history.filter(h => (h.name||"").toLowerCase().includes(q) || (h.matric||"").toLowerCase().includes(q) || (h.reference||"").toLowerCase().includes(q) || String(h.year||"").includes(q));
  const tbody = $("historyTable");
  if(!filtered.length) { tbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center">No matches</td></tr>`; return; }
  tbody.innerHTML = filtered.slice().reverse().map(h=> `<tr class="border-b"><td class="p-2">${escapeHtml(h.name)}</td><td class="p-2">${escapeHtml(h.matric)}</td><td class="p-2">${escapeHtml(h.year)}</td><td class="p-2">${escapeHtml(h.feeType)}</td><td class="p-2">‚Ç¶${Number(h.amount).toLocaleString()}</td><td class="p-2">${new Date(h.date).toLocaleString()}</td><td class="p-2">${escapeHtml(h.reference)}</td><td class="p-2"><button onclick="downloadStoredReceipt('${escapeHtml(h.reference)}')" class="px-2 py-1 bg-sky-700 text-white rounded text-xs">Receipt</button></td></tr>`).join("");
}
window.filterHistory = filterHistory;

/* ---------- Admin UI (client demo) ---------- */
function openAdminModal(){ $("adminModal").classList.remove("hidden"); $("adminPasswordInput").value = ""; $("adminPasswordInput").focus(); }
function closeAdminModal(){ $("adminModal").classList.add("hidden"); $("adminLoginMsg").classList.add("hidden"); }
$("adminLoginBtn")?.addEventListener("click", openAdminModal);
$("adminLoginCancel")?.addEventListener("click", closeAdminModal);
$("adminLoginSubmit")?.addEventListener("click", ()=>{
  const pw = $("adminPasswordInput")?.value || "";
  if(pw === ADMIN_PASSWORD){
    $("navAdmin").classList.remove("hidden");
    $("userRoleDisplay").innerText = "Admin";
    closeAdminModal();
    showSection("admin");
    announce("Admin access granted (client-side)");
    renderAdminTable();
  } else { $("adminLoginMsg").innerText = "Incorrect password"; $("adminLoginMsg").classList.remove("hidden"); }
});

/* Admin table */
async function renderAdminTable(){
  const tbody = $("adminTableBody");
  tbody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";
  // combine local history and Firestore guest_payments + payments (best-effort)
  let rows = history.slice();
  try{
    const guestSnap = await getDocs(collection(db, "guest_payments"));
    guestSnap.forEach(s => rows.push(s.data()));
    // try top-level payments
    try{ const paySnap = await getDocs(collection(db,"payments")); paySnap.forEach(s=> rows.push(s.data())); }catch(e){}
  }catch(e){
    console.warn("admin fetch:", e);
  }
  if(!rows.length) { tbody.innerHTML = "<tr><td colspan='8'>No payments found</td></tr>"; return; }
  rows = rows.sort((a,b)=> new Date(b.date) - new Date(a.date));
  tbody.innerHTML = rows.map(r => `<tr class="border-b"><td class="p-2">${new Date(r.date).toLocaleString()}</td><td class="p-2">${escapeHtml(r.name)}</td><td class="p-2">${escapeHtml(r.matric)}</td><td class="p-2">${escapeHtml(r.year)}</td><td class="p-2">${escapeHtml(r.feeType)}</td><td class="p-2">‚Ç¶${Number(r.amount).toLocaleString()}</td><td class="p-2">${escapeHtml(r.reference)}</td><td class="p-2"><a href="${escapeHtml(r.receiptUrl||'#')}" target="_blank" class="text-indigo-600">Receipt</a></td></tr>`).join("");
}
window.renderAdminTable = renderAdminTable;

/* Download all receipts (client best-effort) */
$("downloadAllReceipts")?.addEventListener("click", ()=>{
  announce("Attempting to open each receipt in a new tab (client). For bulk download use server zip in production.", "info");
  history.forEach(h=>{ if(h.receiptUrl) window.open(h.receiptUrl, "_blank"); });
});

/* ---------- Sidebar navigation & init ---------- */
const sections = {
  dashboard: $("dashboardSection"),
  payment: $("paymentSection"),
  history: $("historySection"),
  profile: $("profileSection"),
  admin: $("adminSection"),
  settings: $("settingsSection")
};
const navButtons = {
  dashboard: $("navDashboard"),
  payment: $("navPayment"),
  history: $("navHistory"),
  profile: $("navProfile"),
  admin: $("navAdmin"),
  settings: $("navSettings")
};
function showSection(key){
  Object.values(sections).forEach(s=> s?.classList.add("hidden"));
  if(sections[key]) sections[key].classList.remove("hidden");
  Object.values(navButtons).forEach(b=> b?.classList.remove("bg-sky-700"));
  if(navButtons[key]) navButtons[key].classList.add("bg-sky-700");
}
Object.keys(navButtons).forEach(k => navButtons[k]?.addEventListener("click", ()=> showSection(k)));

$("menuToggle")?.addEventListener("click", ()=> $("sidebar").classList.toggle("hidden"));
$("darkToggle")?.addEventListener("click", ()=> document.body.classList.toggle("dark"));

/* ---------- Init run on DOMContentLoaded ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // make global functions accessible to inline HTML where needed
  window.makePayment = makePayment;
  window.updateFees = updateFees;
  window.filterHistory = filterHistory;
  window.downloadHistoryPDF = downloadHistoryPDF;
  window.downloadHistoryExcel = downloadHistoryExcel;
  window.exportAdminCSV = exportAdminCSV;

  // wire modal close if backdrop clicked
  document.querySelectorAll("#adminModal, #receiptModal").forEach(modal=>{
    modal.addEventListener("click", (e)=>{ if(e.target === modal) modal.classList.add("hidden"); });
  });

  // load local data
  renderHistory();
  updateSummary();
  renderChart();
  loadProfileToUI();

  // attach updateFees for selects (in case not wired)
  document.querySelectorAll("#studentYear, #paymentType").forEach(i => i?.addEventListener("change", updateFees));

  // default
  showSection("dashboard");
});

/* ---------- Small security notice (console) ---------- */
console.info("PTS Dashboard loaded. Remember: secure admin/persistence with server-side verification and Firestore rules in production.");

</script>
</body>
</html>
