<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTS Payment Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for PDF receipts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <!-- Firebase (compat for simpler browser usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

  <style>
    .receipt-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">

  <div class="flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-blue-900 text-white min-h-screen p-6 hidden md:block">
      <div class="flex items-center gap-3 mb-6">
        <img id="logoSmall" src="logo.png" alt="logo" class="w-12 h-12 object-contain bg-white rounded p-1"/>
        <h2 class="text-2xl font-bold">PTS Payments</h2>
      </div>

      <nav class="mt-4">
        <ul class="space-y-3">
          <li><button onclick="showSection('dashboard')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üè† Dashboard</button></li>
          <li><button onclick="showSection('payment')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üí≥ Make Payment</button></li>
          <li><button onclick="showSection('history')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üìú Payment History</button></li>
          <li><button onclick="showSection('profile')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">üë§ Student Profile</button></li>
          <li><button onclick="showSection('settings')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">‚öô Settings</button></li>
        </ul>
      </nav>

      <div class="mt-8 space-y-3">
        <button onclick="toggleDarkMode()" class="w-full bg-gray-700 text-white py-2 rounded">üåô Toggle Dark Mode</button>
        <button onclick="logoutProfile()" class="w-full bg-red-600 text-white py-2 rounded">üö™ Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">

      <!-- Header -->
      <header class="flex items-center justify-between bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-6">
        <div class="flex items-center gap-4">
          <img id="logoHeader" src="logo.png" alt="PTS Logo" class="h-12 w-12 object-contain bg-white rounded p-1"/>
          <div>
            <h1 class="text-xl font-bold text-blue-900 dark:text-white">PTS Fees Dashboard</h1>
            <p class="text-sm text-gray-500">Payments ‚Ä¢ Receipts ‚Ä¢ Reports</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="menuToggle" onclick="toggleSidebar()" class="md:hidden px-3 py-2 bg-blue-700 text-white rounded">‚ò∞ Menu</button>
          <div class="text-right">
            <div id="userNameDisplay" class="text-sm text-gray-600 dark:text-gray-200">Not signed in</div>
            <div class="text-xs text-gray-400">PTS Payment System</div>
          </div>
        </div>
      </header>

      <!-- Notification -->
      <section id="notificationSection" class="hidden bg-yellow-100 text-yellow-900 p-3 rounded mb-6">
        <p id="notificationMsg">Notification</p>
      </section>

      <!-- Dashboard -->
      <section id="dashboardSection" class="space-y-6">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Total Payments</h3>
            <p id="totalPayments" class="text-2xl font-bold text-blue-700">‚Ç¶0</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Department Fees</h3>
            <p id="totalDept" class="text-2xl font-bold text-green-700">‚Ç¶0</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 shadow rounded-lg">
            <h3 class="text-sm font-semibold text-gray-500">Association Dues</h3>
            <p id="totalSchool" class="text-2xl font-bold text-purple-700">‚Ç¶0</p>
          </div>
        </div>

        <!-- Announcements -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h3 class="font-bold text-blue-900 dark:text-white mb-3">üì¢ Announcements</h3>
          <ul class="list-disc pl-6 text-sm space-y-2">
            <li>Deadline for Year 3 Project Fee Payment: <b>October 30, 2025</b></li>
            <li>New bank details updated for direct transfers</li>
            <li>Orientation for Year 1 students will hold on <b>November 5, 2025</b></li>
          </ul>
        </div>

        <!-- Chart -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <h3 class="font-bold text-blue-900 dark:text-white mb-3">üìä Payment Overview</h3>
          <canvas id="paymentChart" height="200"></canvas>
        </div>
      </section>

      <!-- Payment -->
      <section id="paymentSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 dark:text-white mb-4">üí≥ Make a Payment</h2>

        <form id="paymentForm" class="space-y-4" onsubmit="event.preventDefault(); makePayment();">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="studentName" name="studentName" type="text" placeholder="Full Name" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
            <input id="studentMatric" name="studentMatric" type="text" placeholder="Matric Number" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <select id="studentYear" onchange="updateFees()" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" required>
              <option value="">-- Select Year --</option>
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
            </select>
            <select id="paymentType" onchange="updateFees()" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white">
              <option value="All">All Fees (recommended)</option>
              <option value="Course enrollment">Course enrollment</option>
              <option value="I.T fee">I.T fee</option>
              <option value="Departmental dues">Departmental dues</option>
              <option value="Practical fee">Practical fee</option>
              <option value="Project fee">Project fee</option>
            </select>
          </div>

          <div id="feeBreakdown" class="bg-gray-50 dark:bg-gray-800 p-3 rounded text-sm receipt-mono"></div>

          <!-- NOTE: split preview removed to avoid exposing percentage breakdown -->

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
            <input id="totalAmount" name="totalAmount" type="number" placeholder="Amount" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" readonly>
            <div class="flex gap-2">
              <button type="submit" class="bg-blue-700 text-white py-2 px-4 rounded">Pay Now</button>
            </div>
          </div>
        </form>
      </section>

      <!-- History -->
      <section id="historySection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">üìú Payment History</h2>

        <div class="flex flex-wrap gap-3 mb-4">
          <input id="searchHistory" oninput="filterHistory()" placeholder="üîç Search by Name, Matric, or Year" class="flex-1 border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <button onclick="downloadHistoryPDF()" class="bg-blue-700 text-white px-4 py-2 rounded">‚¨á Export PDF</button>
          <button onclick="downloadHistoryExcel()" class="bg-green-600 text-white px-4 py-2 rounded">‚¨á Export Excel</button>
          <button onclick="clearHistory()" class="bg-red-600 text-white px-4 py-2 rounded">üóëÔ∏è Clear</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full table-auto text-sm">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Matric</th>
                <th class="p-2 text-left">Year</th>
                <th class="p-2 text-left">Fee Type</th>
                <th class="p-2 text-left">Amount</th>
                <th class="p-2 text-left">Date</th>
                <th class="p-2 text-left">Ref</th>
                <th class="p-2 text-left">Receipt</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="bg-white dark:bg-gray-800"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profileSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">üë§ Student Profile</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="profileName" placeholder="Full Name" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <input id="profileMatric" placeholder="Matric Number" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
          <input id="profileEmail" placeholder="Email Address" type="email" class="border rounded px-3 py-2 dark:bg-gray-700 dark:text-white" />
        </div>
        <div class="mt-4 flex gap-3">
          <button onclick="saveProfile()" class="bg-purple-700 text-white px-4 py-2 rounded">Save Profile</button>
          <button onclick="logoutProfile()" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
        </div>
      </section>

      <!-- Settings -->
      <section id="settingsSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded shadow">
        <h2 class="text-lg font-bold text-blue-900 mb-4">‚öô Settings</h2>
        <p class="text-sm text-gray-500">Here you can configure your notifications, backups, and integrations.</p>
      </section>

    </main>
  </div>

<!-- ========================= SCRIPT ========================= -->
<script>
/* ======= Finalized App Script (extended with Firebase) ======= */

/* --------------------- PAYSTACK / SPLIT --------------------- */
// Put your Paystack public key and split code here (already provided by you)
const PAYSTACK_PUBLIC_KEY = "pk_live_258fa9605c51c7f7a1f5c20e0254ddf80671d878";
const PAYSTACK_SPLIT_CODE = "SPL_Ijp4pkn553"; // configured in Paystack dashboard

/* ---------------------- FIREBASE CONFIG --------------------- */
/*
  IMPORTANT: Replace with your Firebase project's config below.
  To get this, open Firebase Console > Project Settings > SDK setup and configuration
*/
const firebaseConfig = {
  apiKey: "AIzaSyBzuQuY_9BSGrhQmN2zuH7bgS8nUOBZRnA",
  authDomain: "pts-bscht.firebaseapp.com",
  projectId: "pts-bscht",
  storageBucket: "pts-bscht.firebasestorage.app",
  messagingSenderId: "860500545291",
  appId: "1:860500545291:web:60df69992bcaddcb0bdc0e",
  measurementId: "G-B9NTEZYFMM"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const functions = firebase.functions();

/* ------------------ OPTIONAL: SIGN-IN ANON (SIMPLE) ------------------
 If you want users to have a per-user dashboard, enable Firebase Authentication.
 The code below signs users in anonymously so payments can be tied to an uid.
 -------------------------------------------------------------------- */
let currentUser = null;
auth.onAuthStateChanged(u => {
  currentUser = u;
  if (u) {
    // user signed in (anonymous or real)
    console.log("Firebase auth user:", u.uid, u.isAnonymous ? "(anonymous)" : "");
    if (document.getElementById("userNameDisplay")) {
      const p = JSON.parse(localStorage.getItem("studentProfile") || "null") || {};
      document.getElementById("userNameDisplay").innerText = p.name || (u.isAnonymous ? "Guest" : "User");
    }
  } else {
    // sign in anonymously
    auth.signInAnonymously().catch(err => {
      console.error("Anonymous sign-in failed:", err);
    });
  }
});

/* ------------------- Fee structure ------------------- */
const fees = {
  1: { "Course enrollment": 200, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  2: { "Course enrollment": 1000, "I.T fee": 7500, "Departmental dues": 6000, "Practical fee": 4000 },
  3: { "Course enrollment": 1000, "Departmental dues": 6000, "Practical fee": 4000, "Project fee": 15000 }
};

/* ------------------- Local data ------------------- */
let history = JSON.parse(localStorage.getItem("paymentHistory") || "[]");
let darkMode = localStorage.getItem("darkMode") === "true";
if (darkMode) document.body.classList.add("dark");

/* ------------------- UI / Navigation ------------------- */
function toggleDarkMode() {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}

function toggleSidebar() {
  const s = document.getElementById("sidebar");
  if (s) s.classList.toggle("hidden");
}

/* showSection fixed to always work: */
function showSection(s) {
  const sections = ["dashboard","payment","history","profile","settings"];
  sections.forEach(id => {
    const el = document.getElementById(id + "Section");
    if (el) el.classList.add("hidden");
  });
  const target = document.getElementById(s + "Section");
  if (target) target.classList.remove("hidden");
  updateSummary();
  renderChart();
  renderHistory();
}
window.showSection = showSection;
window.toggleSidebar = toggleSidebar;
window.toggleDarkMode = toggleDarkMode;

/* ------------------- Payment / Fees ------------------- */
function updateFees(){
  const year = document.getElementById("studentYear")?.value;
  const type = document.getElementById("paymentType")?.value || "All";
  const breakdown = document.getElementById("feeBreakdown");
  if (!breakdown) return;
  breakdown.innerHTML = "";
  if (!year) { if(document.getElementById("totalAmount")) document.getElementById("totalAmount").value = ""; return; }
  const items = fees[year] || {};
  let html = "";
  let total = 0;
  Object.entries(items).forEach(([k, v]) => {
    if (type === "All" || type === k) {
      html += `<div class="flex justify-between"><span>${k}</span><span>‚Ç¶${v.toLocaleString()}</span></div>`;
      total += (type === "All" ? v : (type === k ? v : 0));
    }
  });
  if (type !== "All" && !items[type]) total = 0;
  breakdown.innerHTML = html + `<hr class="my-2"><div class="flex justify-between font-bold"><div>Total</div><div>‚Ç¶${total.toLocaleString()}</div></div>`;
  const totalEl = document.getElementById("totalAmount");
  if (totalEl) totalEl.value = total;
}
window.updateFees = updateFees;

/* ------------------- Make Payment (Paystack + Firebase) ------------------- */
async function makePayment(){
  const name = (document.getElementById("studentName")?.value || "").trim();
  const matric = (document.getElementById("studentMatric")?.value || "").trim();
  const year = document.getElementById("studentYear")?.value;
  const amount = Number(document.getElementById("totalAmount")?.value || 0);
  const type = document.getElementById("paymentType")?.value || "All";
  const email = (document.getElementById("profileEmail")?.value || `${matric}@pts.edu.ng`);

  if (!name || !matric || !year || amount <= 0) {
    return alert("‚ö† Please fill all fields and ensure amount > 0");
  }

  const reference = "PTS_" + Math.floor(Math.random() * 1e9);

  // Setup Paystack inline - split_code included (server-side split configured in dashboard).
  const handler = PaystackPop.setup({
    key: "pk_live_258fa9605c51c7f7a1f5c20e0254ddf80671d878",
    email,
    amount: Math.round(amount * 100), // kobo
    currency: "NGN",
    ref: reference,
    split_code: "SPL_Ijp4pkn553",
    metadata: {
      custom_fields: [
        { display_name: "Student Name", variable_name: "student_name", value: name },
        { display_name: "Matric No", variable_name: "matric", value: matric }
      ]
    },
    callback: async (res) => {
      // On success: build record, save to Firestore, and generate/upload receipt
      const record = {
        name,
        matric,
        year,
        feeType: type,
        amount,
        date: new Date().toISOString(),
        reference: res.reference,
        status: "SUCCESS",
        payerEmail: email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        // Save to local history for instant UI & fallback
        history.push(record);
        localStorage.setItem("paymentHistory", JSON.stringify(history));
        renderHistory();
        updateSummary();
        renderChart();

        // Save to Firestore (per user or guest)
        const uid = (auth.currentUser && auth.currentUser.uid) ? auth.currentUser.uid : null;
        let docRef;
        if (uid) {
          docRef = await db.collection("users").doc(uid).collection("payments").add(record);
        } else {
          docRef = await db.collection("guest_payments").add(record);
        }
        console.log("Saved payment to Firestore at:", docRef.id);

        // Generate receipt PDF (returns blob)
        const { blob, filename } = await generateReceiptPDF(record, true);

        // Upload receipt to Firebase Storage and get URL
        const receiptUrl = await uploadReceiptToStorage(blob, filename, docRef.id);
        console.log("Receipt uploaded:", receiptUrl);

        // Update Firestore record with receipt URL and storage path
        await docRef.update({ receiptUrl, storagePath: `receipts/${docRef.id}/${filename}` });

        // Try to trigger an email via Cloud Function (placeholder)
        // Replace SEND_EMAIL_FUNCTION_URL with your deployed function endpoint
        // or implement a callable Cloud Function and use functions.httpsCallable('sendReceipt')(...)
        // Below is a client-side fetch to your function endpoint:
        const SEND_EMAIL_FUNCTION_URL = "https://us-central1-YOUR_PROJECT.cloudfunctions.net/sendReceiptEmail"; // <-- replace
        // Uncomment and replace with your own function URL
        
        try {
          await fetch(SEND_EMAIL_FUNCTION_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: record.payerEmail, name: record.name, reference: record.reference, receiptUrl })
          });
        } catch (e) {
          console.warn("Email send request failed (implement Cloud Function to send email):", e);
        }
        */

        showNotification("‚úÖ Payment successful! Ref: " + res.reference);
      } catch (err) {
        console.error("Error saving payment or uploading receipt:", err);
        showNotification("‚ö† Payment succeeded but saving/uploading failed. Check console.");
      }
    },
    onClose: () => {
      showNotification("‚ùå Payment window closed.");
    }
  });

  handler.openIframe();
}
window.makePayment = makePayment;

/* ------------------- Receipt Generation (jsPDF) ------------------- */
/**
 * generateReceiptPDF(record, returnBlob)
 *  - record: payment record used to fill the receipt
 *  - returnBlob (bool): if true, returns { blob, filename } instead of saving locally
 *
 * The receipt design uses the #logoHeader img as logo so it's editable by changing that src.
 */
async function generateReceiptPDF(record, returnBlob = false) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let y = 40;

    // Load logo (if present) as dataURL
    const logoImg = document.getElementById("logoHeader");
    let logoDataUrl = null;
    if (logoImg && logoImg.src) {
      try {
        logoDataUrl = await imgToDataURL(logoImg.src);
      } catch (e) {
        console.warn("Could not load logo for receipt:", e);
      }
    }

    // Header
    if (logoDataUrl) {
      const maxLogoWidth = 120;
      doc.addImage(logoDataUrl, "PNG", margin, y, maxLogoWidth, 40);
    }
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.text("PTS Payment Receipt", pageWidth - margin, y + 18, { align: "right" });
    y += 60;

    // Subheader & reference
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Date: ${new Date(record.date).toLocaleString()}`, margin, y);
    doc.text(`Reference: ${record.reference}`, pageWidth - margin, y, { align: "right" });
    y += 22;

    // Payment details box
    doc.setDrawColor(200);
    doc.rect(margin, y, pageWidth - margin * 2, 120, "S");
    let boxY = y + 16;
    const labelX = margin + 8;
    const valX = pageWidth / 2;
    doc.setFontSize(11);

    doc.text("Student Name:", labelX, boxY);
    doc.text(record.name || "-", valX, boxY);
    boxY += 18;

    doc.text("Matric No:", labelX, boxY);
    doc.text(record.matric || "-", valX, boxY);
    boxY += 18;

    doc.text("Year:", labelX, boxY);
    doc.text(String(record.year || "-"), valX, boxY);
    boxY += 18;

    doc.text("Fee Type:", labelX, boxY);
    doc.text(String(record.feeType || "-"), valX, boxY);
    boxY += 18;

    doc.text("Amount Paid:", labelX, boxY);
    doc.text(`‚Ç¶${Number(record.amount).toLocaleString()}`, valX, boxY);
    boxY += 20;

    y += 140;

    // Notes
    doc.setFontSize(10);
    doc.text("Notes:", margin, y);
    y += 14;
    doc.setFontSize(9);
    const noteLines = doc.splitTextToSize("This is an autogenerated receipt. For official verification, check the transaction on Paystack using the reference or contact the bursary. The receipt design is editable via the site's logo and the generateReceiptPDF function.", pageWidth - margin * 2);
    doc.text(noteLines, margin, y);
    y += noteLines.length * 12 + 20;

    // Signature
    doc.setFontSize(11);
    doc.text("__________________", margin, y);
    doc.text("Authorized Signature", margin, y + 14);

    // Footer small
    doc.setFontSize(8);
    doc.text(`Receipt generated by PTS Payments ‚Ä¢ Ref: ${record.reference}`, margin, doc.internal.pageSize.getHeight() - 30);

    // filename
    const filename = `Receipt_${(record.matric || "unknown")}_${record.reference}.pdf`;

    if (returnBlob) {
      const pdfBlob = doc.output("blob");
      return { blob: pdfBlob, filename };
    } else {
      doc.save(filename);
    }
  } catch (err) {
    console.error("Receipt generation failed:", err);
    alert("‚ùå Could not generate receipt PDF.");
    throw err;
  }
}

/* helper: convert image url to dataURL (for jsPDF) */
function imgToDataURL(url) {
  return new Promise((resolve, reject) => {
    // if already data:, return immediately
    if (url.startsWith("data:")) return resolve(url);
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = () => {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const dataURL = canvas.toDataURL("image/png");
        resolve(dataURL);
      } catch (e) {
        reject(e);
      }
    };
    img.onerror = (e) => reject(e);
    img.src = url;
    // in case of cached image blocking crossOrigin load
    if (img.complete) {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const dataURL = canvas.toDataURL("image/png");
        resolve(dataURL);
      } catch (e) {
        // fallback to rejecting; still ok
      }
    }
  });
}

/* ------------------- Upload receipt to Firebase Storage ------------------- */
async function uploadReceiptToStorage(blob, filename, docId) {
  try {
    const path = `receipts/${docId}/${filename}`;
    const storageRef = storage.ref().child(path);
    const snapshot = await storageRef.put(blob);
    const url = await snapshot.ref.getDownloadURL();
    return url;
  } catch (err) {
    console.error("Failed to upload receipt:", err);
    throw err;
  }
}

/* ------------------- History & Export ------------------- */
function renderHistory(){
  const tbody = document.getElementById("historyTable");
  if (!tbody) return;
  // If Firestore used, try to load latest from Firestore (optional)
  tbody.innerHTML = history.map((h, idx) => `
    <tr class="border-b">
      <td class="p-2">${escapeHtml(h.name)}</td>
      <td class="p-2">${escapeHtml(h.matric)}</td>
      <td class="p-2">${escapeHtml(h.year)}</td>
      <td class="p-2">${escapeHtml(h.feeType)}</td>
      <td class="p-2">‚Ç¶${Number(h.amount).toLocaleString()}</td>
      <td class="p-2">${new Date(h.date).toLocaleString()}</td>
      <td class="p-2">${escapeHtml(h.reference || "-")}</td>
      <td class="p-2"><button onclick="downloadStoredReceipt('${escapeHtml(h.reference)}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Download Receipt</button></td>
    </tr>`).join("");
}

async function downloadStoredReceipt(reference) {
  // Look up Firestore for receiptUrl (search guest_payments and user collections)
  try {
    // Search current user's collection first
    let url = null;
    if (auth.currentUser && auth.currentUser.uid) {
      const q = await db.collection("users").doc(auth.currentUser.uid).collection("payments").where("reference", "==", reference).limit(1).get();
      if (!q.empty) {
        url = q.docs[0].data().receiptUrl;
      }
    }
    if (!url) {
      const q2 = await db.collection("guest_payments").where("reference", "==", reference).limit(1).get();
      if (!q2.empty) url = q2.docs[0].data().receiptUrl;
    }
    if (url) {
      window.open(url, "_blank");
    } else {
      alert("Receipt not found in storage. If the payment was recent, try refreshing.");
    }
  } catch (e) {
    console.error("Error fetching receipt URL:", e);
    alert("Could not fetch receipt. Check console.");
  }
}

function filterHistory(){
  const q = (document.getElementById("searchHistory")?.value || "").toLowerCase().trim();
  const filtered = history.filter(h =>
    (h.name || "").toLowerCase().includes(q) ||
    (h.matric || "").toLowerCase().includes(q) ||
    String(h.year).includes(q) ||
    ((h.reference || "").toLowerCase().includes(q))
  );
  const tbody = document.getElementById("historyTable");
  if (!tbody) return;
  tbody.innerHTML = filtered.map((h, idx) => `
    <tr class="border-b">
      <td class="p-2">${escapeHtml(h.name)}</td>
      <td class="p-2">${escapeHtml(h.matric)}</td>
      <td class="p-2">${escapeHtml(h.year)}</td>
      <td class="p-2">${escapeHtml(h.feeType)}</td>
      <td class="p-2">‚Ç¶${Number(h.amount).toLocaleString()}</td>
      <td class="p-2">${new Date(h.date).toLocaleString()}</td>
      <td class="p-2">${escapeHtml(h.reference || "-")}</td>
      <td class="p-2"><button onclick="downloadStoredReceipt('${escapeHtml(h.reference)}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Download Receipt</button></td>
    </tr>`).join("");
}
window.filterHistory = filterHistory;

function downloadHistoryPDF(){
  if (!history.length) return alert("No history to export.");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const margin = 40;
  let y = 40;
  doc.setFontSize(16);
  doc.text("PTS Payment History", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
  y += 30;
  doc.setFontSize(10);
  history.forEach(h => {
    const line = `${new Date(h.date).toLocaleString()} | ${h.name} | ${h.matric} | ${h.feeType} | ‚Ç¶${Number(h.amount).toLocaleString()} | Ref: ${h.reference || "-"}`;
    doc.text(line, margin, y);
    y += 14;
    if (y > doc.internal.pageSize.getHeight() - 60) {
      doc.addPage();
      y = 40;
    }
  });
  doc.save("PTS_Payment_History.pdf");
}
window.downloadHistoryPDF = downloadHistoryPDF;

function downloadHistoryExcel(){
  if (!history.length) return alert("No history available");
  try {
    const worksheetData = history.map(h => ({
      Date: new Date(h.date).toLocaleString(),
      Name: h.name,
      Matric: h.matric,
      Year: h.year,
      FeeType: h.feeType,
      Amount: h.amount,
      Reference: h.reference || "-"
    }));
    const ws = XLSX.utils.json_to_sheet(worksheetData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "History");
    XLSX.writeFile(wb, "PTS_Payment_History.xlsx");
  } catch (err) {
    console.error(err);
    alert("‚ùå Excel export failed.");
  }
}
window.downloadHistoryExcel = downloadHistoryExcel;

function clearHistory(){
  if (!confirm("Clear local payment history? This will remove local entries.")) return;
  history = [];
  localStorage.removeItem("paymentHistory");
  renderHistory();
  updateSummary();
  renderChart();
}
window.clearHistory = clearHistory;

/* ------------------- Summary & Charts ------------------- */
function updateSummary() {
  let total = 0, dept = 0, school = 0;
  history.forEach(h => {
    const amt = Number(h.amount) || 0;
    total += amt;
    const ft = (h.feeType || "").toLowerCase();
    if (ft.includes("department")) dept += amt;
    if (ft.includes("association") || ft.includes("school")) school += amt;
  });
  const totalEl = document.getElementById("totalPayments");
  const deptEl = document.getElementById("totalDept");
  const schoolEl = document.getElementById("totalSchool");
  if (totalEl) totalEl.innerText = "‚Ç¶" + total.toLocaleString();
  if (deptEl) deptEl.innerText = "‚Ç¶" + dept.toLocaleString();
  if (schoolEl) schoolEl.innerText = "‚Ç¶" + school.toLocaleString();
}

let myChart = null;
function renderChart(){
  const canvas = document.getElementById("paymentChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const deptTotal = history.filter(h => (h.feeType || "").toLowerCase().includes("department")).reduce((s, r) => s + Number(r.amount), 0);
  const schoolTotal = history.filter(h => (h.feeType || "").toLowerCase().includes("association") || (h.feeType || "").toLowerCase().includes("school")).reduce((s, r) => s + Number(r.amount), 0);
  const other = history.reduce((s, r) => s + Number(r.amount), 0) - deptTotal - schoolTotal;

  if (myChart) myChart.destroy();
  myChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Departmental", "Association/School", "Other"],
      datasets: [{ data: [deptTotal, schoolTotal, other], backgroundColor: ["#34d399","#8b5cf6","#f59e0b"] }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
  });
}

/* ------------------- Profile / Auth helpers ------------------- */
function saveProfile(){
  const p = {
    name: (document.getElementById("profileName")?.value || "").trim(),
    matric: (document.getElementById("profileMatric")?.value || "").trim(),
    email: (document.getElementById("profileEmail")?.value || "").trim()
  };
  localStorage.setItem("studentProfile", JSON.stringify(p));
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = p.name || "Not signed in";
  // prefill payment form
  if (p.name) document.getElementById("studentName").value = p.name;
  if (p.matric) document.getElementById("studentMatric").value = p.matric;
  showNotification("Profile saved locally.");
}
window.saveProfile = saveProfile;

function loadProfile(){
  const p = JSON.parse(localStorage.getItem("studentProfile") || "null");
  if (!p) return;
  if (document.getElementById("profileName")) document.getElementById("profileName").value = p.name || "";
  if (document.getElementById("profileMatric")) document.getElementById("profileMatric").value = p.matric || "";
  if (document.getElementById("profileEmail")) document.getElementById("profileEmail").value = p.email || "";
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = p.name || "Not signed in";
  if (document.getElementById("studentName")) document.getElementById("studentName").value = p.name || "";
  if (document.getElementById("studentMatric")) document.getElementById("studentMatric").value = p.matric || "";
}
window.loadProfile = loadProfile;

function logoutProfile(){
  localStorage.removeItem("studentProfile");
  if (document.getElementById("userNameDisplay")) document.getElementById("userNameDisplay").innerText = "Not signed in";
  showNotification("Logged out (local profile cleared).");
}
window.logoutProfile = logoutProfile;

/* ------------------- Utilities ------------------- */
function escapeHtml(s){ if (!s) return ""; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function showNotification(msg) {
  const el = document.getElementById("notificationSection");
  if (!el) return;
  document.getElementById("notificationMsg").innerText = msg;
  el.classList.remove("hidden");
  setTimeout(() => el.classList.add("hidden"), 4500);
}

/* ------------------- Init on DOM ready ------------------- */
document.addEventListener("DOMContentLoaded", () => {
  showSection("dashboard");
  renderHistory();
  updateSummary();
  renderChart();
  loadProfile();

  document.getElementById("studentYear")?.addEventListener("change", updateFees);
  document.getElementById("paymentType")?.addEventListener("change", updateFees);

  // ensure menu toggle for mobile works
  document.getElementById("menuToggle")?.addEventListener("click", toggleSidebar);
});
</script>
</body>
</html>
